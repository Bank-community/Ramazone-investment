<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RMZ Investment Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #4895ef;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    /* Login Page Styles */
    .login-container {
      display: flex; /* Changed from none to flex by default */
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f5f7fa;
    }

    .login-form {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    .login-form h2 {
      color: var(--primary);
      margin-bottom: 20px;
    }

    .login-input {
      width: 100%;
      padding: 12px 15px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }

    .login-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
      margin-top: 10px;
      transition: background 0.3s;
    }

    .login-btn:hover {
      background: var(--primary-dark);
    }

    .forgot-password {
      display: block;
      margin-top: 10px;
      color: var(--gray);
      text-decoration: none;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .forgot-password:hover {
      text-decoration: underline;
    }

    .error-message {
      color: var(--danger);
      margin-top: 10px;
      display: none;
    }

    /* Dashboard Styles */
    .dashboard {
      display: none; /* Initially hidden, shown after login */
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px;
    }

    /* Advertisement Banner with Slider */
    .ad-banner {
      width: 100%;
      height: 150px;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
      position: relative;
    }

    .ad-slide {
      width: 100%;
      height: 100%;
      position: absolute;
      opacity: 0;
      transition: opacity .5s ease-in-out;
    }

    .ad-slide.active {
      opacity: 1;
    }

    .ad-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

/* ======= Updated CSS for Top Investors Card ======= */

/* Container for the whole Top Investors section */
.top-investors {
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  margin-bottom: 20px;
}

/* Heading for the section */
.top-investors h2 {
  color: var(--primary);
  margin-bottom: 20px;
  font-size: 1.3rem;
  display: flex;
  align-items: center;
}

.top-investors h2 i {
  margin-right: 10px;
  color: var(--warning); /* Trophy icon color */
}

/* Flex container for the list of investor cards */
.investor-list {
  display: flex;
  gap: 15px;
  flex-wrap: wrap; /* Allow cards to wrap on smaller screens */
}

/* Base styles for EACH investor card */
.investor-card {
  flex: 1; /* Allows cards to grow and fill space */
  min-width: 250px; /* Minimum width before wrapping */
  padding: 15px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  transition: transform 0.3s, box-shadow 0.3s;
  position: relative; /* Needed for potential absolute positioning inside */
  overflow: hidden; /* Clips content like background image */
  color: white; /* Default text color set to white for background images */

  /* Common background properties (applied to all cards) */
  background-size: cover; /* Scale image to cover the card */
  background-position: center; /* Center the image */

  /* REMOVED the single background-image here, will be set per card below */
  /* background-image: url('...'); */
}

/* Hover effect for cards */
.investor-card:hover {
  transform: translateY(-5px); /* Lift card slightly */
  box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* Darker shadow on hover */
}

/* Text shadow for readability on ALL cards */
.investor-card .investor-details,
.investor-card .investor-avatar {
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); /* Dark shadow for contrast */
}

/* === Individual Background Images for Top 3 Cards === */
/* Uses :nth-child() to target the 1st, 2nd, and 3rd card in the list */

.investor-list .investor-card:nth-child(1) {
  /* Background for the #1 Ranked Investor */
  background-image: url('https://i.postimg.cc/W19PngLL/image-search-1743881691568.jpg'); /* Replace with your desired image URL for Rank 1 (e.g., gold theme) */
}

.investor-list .investor-card:nth-child(2) {
  /* Background for the #2 Ranked Investor */
  background-image: url('https://i.postimg.cc/8zvhdBrs/1743882273499.jpg'); /* Replace with your desired image URL for Rank 2 (e.g., silver theme) */
}

.investor-list .investor-card:nth-child(3) {
  /* Background for the #3 Ranked Investor */
  background-image: url('https://i.postimg.cc/KzTSxWKx/image-search-1743881642421.jpg'); /* Replace with your desired image URL for Rank 3 (e.g., bronze theme) */
}

/* Styles for the investor's avatar (circle) */
.investor-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%; /* Make it a circle */
  background-color: rgba(67, 97, 238, 0.5); /* Fallback/overlay color (semi-transparent) */
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 1.5rem;
  margin-right: 15px;
  overflow: hidden; /* Hide parts of image that overflow the circle */
  border: 2px solid rgba(255, 255, 255, 0.5); /* Optional subtle white border */
  flex-shrink: 0; /* Prevent avatar from shrinking */
}

/* Style for the image inside the avatar */
.investor-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* Cover the area, cropping if necessary */
}

/* Container for text details (name, rank, shares) */
.investor-details {
  flex: 1; /* Takes remaining space */
}

/* Style for the rank badge (e.g., #1) */
.investor-rank {
  font-size: 0.8rem;
  color: white;
  background: var(--warning); /* Orange background */
  padding: 2px 8px;
  border-radius: 10px;
  display: inline-block; /* Allows background and padding */
  margin-bottom: 5px;
}

/* Style for the investor's name */
.investor-name {
  font-weight: 600;
  margin-bottom: 3px;
  color: white; /* Ensure name is white */
}

/* Style for the shares info text */
.investor-shares {
  color: var(--light-gray); /* Light gray for shares text */
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  flex-wrap: wrap; /* Allow amount to wrap if needed */
}

/* Style for the coin icon */
.investor-shares i {
  margin-right: 5px;
  color: var(--success); /* Icon color */
}

/* Style for the calculated amount (e.g., ₹5000) */
.investor-amount {
  font-size: 0.9rem;
  font-weight: bold;
  color: white; /* Ensure amount is white */
  margin-left: 5px; /* Space between shares text and amount */
}

/* ======= End of Updated CSS ======= */


    /* User Profile Card - Enhanced */
    .profile-card {
      background: linear-gradient(135deg, #8A2BE2, #DDA0DD);
      color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      flex-direction: column; /* Arrange items vertically */
      align-items: center; /* Center items horizontally */
      position: relative; /* For positioning the menu */
      overflow: hidden;
      text-align: center; /* Center text within the card */
    }

    .profile-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.15);
      transform: rotate(-45deg) translate(0, -50%);
      /* Removed animation: shine 3s infinite; */
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 2.5rem;
      margin-bottom: 15px;
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-details {
      width: 100%;
    }

    .profile-name {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 5px;
      color: inherit; /* Inherit color from profile-card */
    }

    .profile-id {
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .profile-mobile {
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .profile-stats {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-item {
      background: rgba(255, 255, 255, 0.15);
      padding: 10px;
      border-radius: 6px;
    }

    .stat-label {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 3px;
    }

    .stat-value {
      font-weight: 600;
      font-size: 1.1rem;
      color: inherit; /* Inherit color from profile-card */
    }

    /* Menu Button Style */
    .menu-button-container {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
    }

    .notification-icon {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1.5rem;
      padding: 5px;
      margin-right: 10px;
      position: relative; /* For red dot */
    }

    .notification-icon:hover {
      color: var(--light-gray);
    }

    .notification-dot {
      height: 8px;
      width: 8px;
      background-color: red;
      border-radius: 50%;
      position: absolute;
      top: 5px;
      right: 5px;
      display: none; /* Hidden by default */
    }

    .menu-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1.5rem;
      padding: 5px;
      transition: color 0.3s;
    }

    .menu-button:hover {
      color: var(--light-gray);
    }

    .menu-dropdown {
      position: absolute;
      top: 40px;
      right: 10px;
      background-color: white;
      border: 1px solid var(--light-gray);
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 10;
      display: none;
      width: 150px;
    }

    .menu-dropdown.open {
      display: block;
    }

    .menu-dropdown button {
      display: block;
      width: 100%;
      padding: 10px 15px;
      text-align: left;
      border: none;
      background: none;
      color: var(--dark);
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .menu-dropdown button:hover {
      background-color: var(--light-gray);
    }

    /* Notifications Modal Styles */
    #notificationsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .notification-popup {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      position: relative;
    }

    .notification-popup h2 {
      color: var(--primary);
      margin-bottom: 15px;
    }

    .notification-popup .notification-image {
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
    }

    .notification-popup p {
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .notification-link-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      text-decoration: none;
      display: inline-block;
    }

    .close-modal-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      font-size: 1.2rem;
    }

    /* Shares Chart */
    .shares-chart {
      background: white;
      border-radius: 5px;
      padding: 0px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .shares-chart h2 {
      color: var(--primary);
      margin-bottom: 15px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
    }

    .shares-chart h2 i {
      margin-right: 10px;
      color: var(--info);
    }

    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* Return Percentage Cards */
    .return-percentage-container {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      margin-bottom: 20px;
      overflow-x: auto; /* For smaller screens */
      padding-bottom: 10px; /* To see the full shadow if any */
    }

    .return-card {
      background: #f0e68c; /* Initial light yellow */
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      text-align: center;
      min-width: 120px;
    }

    .return-card.year-1 {
      background: #fffacd; /* Light yellow */
    }

    .return-card.year-2 {
      background: #eee8aa; /* Slightly darker yellow */
    }

    .return-card.year-3 {
      background: #e0e080; /* Medium yellow */
    }

    .return-card.year-4 {
      background: #ffd700; /* Golden yellow */
    }

    .return-card.year-5 {
      background: #ffb347; /* Darker golden yellow */
    }

    .return-card h3 {
      font-size: 1rem;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .return-card .percentage {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--success);
      margin-bottom: 5px;
    }

    .return-card .amount {
      font-size: 0.9rem;
      color: var(--gray);
    }

    /* Shares Summary */
    .shares-summary {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .shares-summary h2 {
      color: var(--primary);
      margin-bottom: 15px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
    }

    .shares-summary h2 i {
      margin-right: 10px;
      color: var(--success);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .summary-card {
      background: #aed9e0; /* Light blue */
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      transition: transform 0.3s;
    }

    .summary-card:hover {
      transform: translateY(-3px);
    }

    .summary-card .title {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 5px;
    }

    .summary-card .value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
    }

    .progress-container {
      margin-top: 15px;
      height: 8px;
      background: var(--light-gray);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Footer Styles */
    .dashboard > footer {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-around;
      align-items: center;
      font-size: 0.9rem;
      color: var(--gray);
    }

    .footer-card {
      flex: 1;
      margin: 5px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      text-align: center;
      text-decoration: none;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .footer-card i {
      font-size: 1.2rem;
    }

    .ramazone-store {
      background-color: red;
    }

    .whatsapp-chat {
      background-color: green;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .investor-list {
        flex-direction: column;
      }

      .investor-card {
        min-width: 100%;
      }

      .profile-card {
        flex-direction: column;
        text-align: center;
      }

      .profile-avatar {
        margin-right: 0;
        margin-bottom: 15px;
      }

      .profile-details {
        text-align: center;
      }

      .summary-grid {
        grid-template-columns: 1fr 1fr;
      }

      .dashboard > footer {
        flex-direction: column;
      }

      .footer-card {
        margin: 10px 0;
      }
    }

    @media (max-width: 480px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }

      .profile-stats {
        grid-template-columns: 1fr;
      }
    }

    /* Loading States */
    .loading {
      position: relative;
      overflow: hidden;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

  </style>
</head>
<body>

<div id="loginScreen" class="login-container">
  <div class="login-form">
    <h2>RMZ Investor Login</h2>
    <input type="email" id="loginEmail" class="login-input" placeholder="Enter your email" required>
    <input type="password" id="loginPassword" class="login-input" placeholder="Enter your password" required>
    <button class="login-btn" onclick="loginUser()">Login</button>
    <a class="forgot-password" onclick="showForgotPassword()">Forgot Password?</a>
    <p id="loginError" class="error-message">Invalid email or password</p>
  </div>
</div>

<div id="forgotPasswordModal" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:10px; width:90%; max-width:400px;">
    <h2 style="color:#4361ee; margin-bottom:20px;">Reset Password</h2>
    <input type="email" id="resetEmail" placeholder="Enter your email" style="width:100%; padding:12px 15px; margin-bottom:15px; border:1px solid #ddd; border-radius:5px;">
    <button onclick="sendPasswordReset()" style="background:#4361ee; color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer; width:100%;">Send Reset Link</button>
    <button onclick="hideForgotPassword()" style="background:#6c757d; color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer; width:100%; margin-top:10px;">Cancel</button>
    <p id="resetMessage" style="margin-top:15px; display:none;"></p>
  </div>
</div>

<div id="notificationsModal" style="display:none;">
  <div class="notification-popup">
    <button class="close-modal-btn" onclick="closeNotificationsModal()">&times;</button>
    <h2 id="notificationHeadline"></h2>
    <img id="notificationImage" src="" alt="" class="notification-image" style="display: none;">
    <p id="notificationSummary"></p>
    <a id="notificationLink" href="#" target="_blank" class="notification-link-btn" style="display: none;">Click Here</a>
  </div>
</div>

<div id="changePasswordModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; display:flex; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:10px; width:90%; max-width:400px; position: relative;">
    <button class="close-modal-btn" onclick="closeChangePasswordModal()">&times;</button>
    <h2 style="color:#4361ee; margin-bottom:20px;">Change Password</h2>
    <input type="password" id="currentPassword" placeholder="Current Password" style="width:100%; padding:12px 15px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
    <input type="password" id="newPassword" placeholder="New Password" style="width:100%; padding:12px 15px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
    <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" style="width:100%; padding:12px 15px; margin-bottom:15px; border:1px solid #ddd; border-radius:5px;">
    <button onclick="updatePassword()" style="background:#4361ee; color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer; width:100%;">Change Password</button>
    <p id="passwordChangeMessage" style="margin-top:15px; display:none;"></p>
  </div>
</div>

<div id="dashboard" class="dashboard">
  <div class="ad-banner">
    <div class="ad-slide active">
      <a href="https://example.com/link1" target="_blank">
        <img src="https://i.postimg.cc/3J367fQT/20250405-105443.png">
      </a>
    </div>
    <div class="ad-slide">
      <a href="https://example.com/link2" target="_blank">
        <img src="https://i.postimg.cc/13XyR31s/20250405-111536.png">
      </a>
    </div>
    <div class="ad-slide">
      <a href="https://example.com/link3" target="_blank">
        <img src="https://i.postimg.cc/SxgjVPkN/20250405-111107.jpg">
      </a>
    </div>
  </div>

  <div class="top-investors">
    <h2><i class="fas fa-trophy"></i> Top Investors</h2>
    <div class="investor-list" id="topInvestors">
      <div class="investor-card loading">
        <div class="investor-avatar"></div>
        <div class="investor-details">
          <div class="investor-rank">#1</div>
          <div class="investor-name">Loading...</div>
          <div class="investor-shares">
            <i class="fas fa-coins"></i>
            0 Shares (<span class="investor-amount">₹0</span>)
          </div>
        </div>
      </div>
      <div class="investor-card loading">
        <div class="investor-avatar"></div>
        <div class="investor-details">
          <div class="investor-rank">#2</div>
          <div class="investor-name">Loading...</div>
          <div class="investor-shares">
            <i class="fas fa-coins"></i>
            0 Shares (<span class="investor-amount">₹0</span>)
          </div>
        </div>
      </div>
      <div class="investor-card loading">
        <div class="investor-avatar"></div>
        <div class="investor-details">
          <div class="investor-rank">#3</div>
          <div class="investor-name">Loading...</div>
          <div class="investor-shares">
            <i class="fas fa-coins"></i>
            0 Shares (<span class="investor-amount">₹0</span>)
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="profile-card" id="userProfile">
    <div class="menu-button-container">
      <button class="notification-icon" onclick="showNotificationsModal()">
        <i class="fas fa-bell"></i>
        <span class="notification-dot" id="notificationDot"></span>
      </button>
      <button class="menu-button" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="menu-dropdown" id="profileMenu">
      <button onclick="showChangePasswordModal()">Change Password</button>
      <button onclick="logoutUser()">Logout</button>
    </div>
    <div class="profile-avatar loading"></div>
    <div class="profile-details">
      <div class="profile-name loading"></div>
      <div class="profile-id loading"></div>
      <div class="profile-mobile loading"></div>
      <div class="profile-stats">
        <div class="stat-item">
          <div class="stat-label">Shares</div>
          <div class="stat-value" id="userShares">Loading...</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Investment</div>
          <div class="stat-value" id="userInvestment">Loading...</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Member Since</div>
          <div class="stat-value" id="memberSince">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="shares-chart">
    <h2><i class="fas fa-chart-bar"></i> Shares Distribution</h2>
    <div class="chart-container">
      <canvas id="sharesChart"></canvas>
    </div>
  </div>

  <div class="return-percentage-container" id="returnPercentageCards">
    </div>

  <div class="shares-summary">
    <h2><i class="fas fa-chart-pie"></i> Shares Overview</h2>
    <div class="summary-grid">
      <div class="summary-card" id="soldSharesCard">
        <div class="title">Sold Shares</div>
        <div class="value loading">...</div>
        <div class="progress-container" id="soldProgress">
          <div class="progress-bar" style="width: 0%;"></div>
        </div>
      </div>
      <div class="summary-card" id="availableSharesCard">
        <div class="title">Available Shares</div>
        <div class="value loading">...</div>
        <div class="progress-container" id="availableProgress">
          <div class="progress-bar" style="width: 0%;"></div>
        </div>
      </div>
      <div class="summary-card">
        <div class="title">Total Investors</div>
        <div class="value loading" id="totalInvestors">...</div>
      </div>
      <div class="summary-card">
        <div class="title">Total Shares</div>
        <div class="value">1000</div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <a href="https://ramazone.store.shoopy.in" target="_blank" class="footer-card ramazone-store">
      <i class="fas fa-store"></i> Ramazone Store
    </a>
<a href="https://wa.me/917903698180?text=*Ramazone%20Investment*%0A%0Aplease%20help%20me" target="_blank" class="footer-card whatsapp-chat">  
  <i class="fab fa-whatsapp"></i> WhatsApp Chat  
</a>
  </footer>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCV_IDpmD35weDRi4GDegnT2m2RV_qHclc",
    authDomain: "re-sh-51ff6.firebaseapp.com",
    databaseURL: "https://re-sh-51ff6-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "re-sh-51ff6",
    storageBucket: "re-sh-51ff6.firebasestorage.app",
    messagingSenderId: "870340778217",
    appId: "1:870340778217:web:7dd6792c2bb80cdee6b878",
    measurementId: "G-E3884F19J2"
  };


  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // Global variables
  let currentUser = null;
  let sharesChart = null;
  let adInterval = null;
  let usersRef = null;
  let notificationsRef = null;
  let newNotification = false; // Flag to track new notifications

  // --- DOM Elements ---
  const loginScreen = document.getElementById('loginScreen');
  const dashboardScreen = document.getElementById('dashboard');
  const forgotPasswordModal = document.getElementById('forgotPasswordModal');
  const notificationsModal = document.getElementById('notificationsModal');
  const changePasswordModal = document.getElementById('changePasswordModal');
  const profileMenu = document.getElementById('profileMenu');
  const notificationDot = document.getElementById('notificationDot');


  // Function to toggle the profile menu
  function toggleMenu() {
    profileMenu.classList.toggle('open');
  }

  // Logout function
  function logoutUser() {
    auth.signOut().then(() => {
      // Sign-out successful. Handled by onAuthStateChanged
      console.log("User logged out");
    }).catch((error) => {
      // An error happened.
      console.error("Logout error:", error);
      alert("Error logging out. Please try again.");
    });
  }

  // Function to show the notifications modal
  function showNotificationsModal() {
    profileMenu.classList.remove('open');
    notificationsModal.style.display = 'flex';
    // Reset new notification indicator when modal is opened
    notificationDot.style.display = 'none';
    newNotification = false;
    loadNotifications();
  }

  // Function to close the notifications modal
  function closeNotificationsModal() {
    notificationsModal.style.display = 'none';
  }

  // Function to load notifications from Firebase
  function loadNotifications() {
    if (!notificationsRef) {
      notificationsRef = db.ref('notifications');
    }
    notificationsRef.limitToLast(1).once('value', (snapshot) => { // Get the latest notification
      if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => { // Iterate (though only one expected)
            const notification = childSnapshot.val();
            document.getElementById('notificationHeadline').textContent = notification.headline || 'Notification';
            const imageElement = document.getElementById('notificationImage');
            if (notification.imageLink) {
              imageElement.src = notification.imageLink;
              imageElement.style.display = 'block';
            } else {
              imageElement.style.display = 'none';
            }
            document.getElementById('notificationSummary').textContent = notification.summary || '';
            const linkElement = document.getElementById('notificationLink');
            if (notification.link) {
              linkElement.href = notification.link;
              linkElement.style.display = 'inline-block';
            } else {
              linkElement.style.display = 'none';
            }
         });
      } else {
        document.getElementById('notificationHeadline').textContent = 'No New Notifications';
        document.getElementById('notificationSummary').textContent = '';
        document.getElementById('notificationImage').style.display = 'none';
        document.getElementById('notificationLink').style.display = 'none';
      }
    }).catch(error => {
        console.error("Error loading notifications:", error);
        document.getElementById('notificationHeadline').textContent = 'Error Loading Notifications';
    });
  }

  // Function to show the change password modal
  function showChangePasswordModal() {
    profileMenu.classList.remove('open');
    // Clear previous messages and inputs
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmNewPassword').value = '';
    document.getElementById('passwordChangeMessage').style.display = 'none';
    changePasswordModal.style.display = 'flex';
  }

  // Function to close the change password modal
  function closeChangePasswordModal() {
    changePasswordModal.style.display = 'none';
  }

  // Function to update the user's password
  function updatePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    const messageElement = document.getElementById('passwordChangeMessage');

    messageElement.style.display = 'none'; // Hide previous message

    if (!currentPassword || !newPassword || !confirmNewPassword) {
      messageElement.textContent = 'Please fill in all fields.';
      messageElement.style.color = 'red';
      messageElement.style.display = 'block';
      return;
    }

    if (newPassword !== confirmNewPassword) {
      messageElement.textContent = 'New passwords do not match.';
      messageElement.style.color = 'red';
      messageElement.style.display = 'block';
      return;
    }

    if (newPassword.length < 6) {
      messageElement.textContent = 'New password must be at least 6 characters long.';
      messageElement.style.color = 'red';
      messageElement.style.display = 'block';
      return;
    }

    const user = auth.currentUser;

    if (user) {
      // Re-authenticate user
      const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
      user.reauthenticateWithCredential(credential)
        .then(() => {
          // User re-authenticated. Now update password.
          return user.updatePassword(newPassword);
        })
        .then(() => {
          messageElement.textContent = 'Password updated successfully!';
          messageElement.style.color = 'green';
          messageElement.style.display = 'block';
          // Clear fields after success
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmNewPassword').value = '';
          setTimeout(() => closeChangePasswordModal(), 3000); // Close modal after 3s
        })
        .catch((error) => {
          console.error("Password update error:", error);
          if (error.code === 'auth/wrong-password') {
             messageElement.textContent = 'Incorrect current password.';
          } else {
             messageElement.textContent = 'Error updating password: ' + error.message;
          }
          messageElement.style.color = 'red';
          messageElement.style.display = 'block';
        });
    } else {
      messageElement.textContent = 'No user logged in. Cannot change password.';
      messageElement.style.color = 'red';
      messageElement.style.display = 'block';
    }
  }

  // Login function
  function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorMsg = document.getElementById('loginError');
    const loginBtn = document.querySelector('.login-btn');

    errorMsg.style.display = 'none'; // Hide previous errors

    if (!email || !password) {
      errorMsg.textContent = "Please enter both email and password";
      errorMsg.style.display = 'block';
      return;
    }

    // Show loading state
    loginBtn.disabled = true;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';

    auth.signInWithEmailAndPassword(email, password)
      .then((userCredential) => {
        // Login successful - handled by onAuthStateChanged
        console.log("Login successful for:", userCredential.user.email);
        // No need to manually show dashboard here, onAuthStateChanged handles it
      })
      .catch((error) => {
        console.error("Login error:", error);
        let errorMessage = "Login failed. Please try again.";
        switch(error.code) {
          case "auth/user-not-found":
            errorMessage = "No account found with this email.";
            break;
          case "auth/wrong-password":
            errorMessage = "Incorrect password.";
            break;
          case "auth/too-many-requests":
            errorMessage = "Too many login attempts. Please try again later.";
            break;
          case "auth/invalid-email":
             errorMessage = "Invalid email format.";
             break;
        }
        errorMsg.textContent = errorMessage;
        errorMsg.style.display = 'block';
      })
      .finally(() => {
        // Reset button state
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      });
  }

  // Set up real-time database listener
  function setupRealtimeListener() {
    // Detach previous listeners if they exist to avoid duplicates
    if (usersRef) {
      usersRef.off();
    }
    if (notificationsRef) {
        notificationsRef.off();
    }

    // Listen for user data changes
    usersRef = db.ref('users');
    usersRef.on('value', (snapshot) => {
      loadDashboardData(snapshot); // Pass snapshot directly
    }, (error) => {
      console.error("Error fetching users data:", error);
      // Display a more user-friendly error on the dashboard
      document.getElementById('profileName').textContent = "Error loading data";
      // Clear loading states to prevent infinite spinners
      clearLoadingStates();
    });

    // Listen for new notifications
    notificationsRef = db.ref('notifications');
    notificationsRef.limitToLast(1).on('child_added', (snapshot) => {
      // Only show dot if user is logged in and dashboard is visible
      if (currentUser && dashboardScreen.style.display === 'block') {
        notificationDot.style.display = 'block';
        newNotification = true;
      }
    });
  }

  // Forgot password functions
  function showForgotPassword() {
    // Hide login form elements if needed, show modal
    forgotPasswordModal.style.display = 'flex';
    document.getElementById('resetEmail').value = ''; // Clear email field
    document.getElementById('resetMessage').style.display = 'none'; // Hide any previous message
  }

  function hideForgotPassword() {
    forgotPasswordModal.style.display = 'none';
  }

  function sendPasswordReset() {
    const email = document.getElementById('resetEmail').value;
    const message = document.getElementById('resetMessage');
    const resetBtn = forgotPasswordModal.querySelector('button:first-of-type');

    message.style.display = 'none'; // Hide previous message

    if (!email) {
      message.textContent = "Please enter your email address.";
      message.style.color = "red";
      message.style.display = "block";
      return;
    }

    // Show loading state on button
    resetBtn.disabled = true;
    resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    auth.sendPasswordResetEmail(email)
      .then(() => {
        message.textContent = "Password reset email sent! Please check your inbox (and spam folder).";
        message.style.color = "green";
        message.style.display = "block";
         // Optionally hide the modal after a delay
         // setTimeout(hideForgotPassword, 5000);
      })
      .catch((error) => {
        console.error("Password reset error:", error);
        if (error.code === 'auth/user-not-found') {
            message.textContent = "No user found with this email address.";
        } else if (error.code === 'auth/invalid-email') {
            message.textContent = "Invalid email format.";
        }
        else {
            message.textContent = "Error sending reset email: " + error.message;
        }
        message.style.color = "red";
        message.style.display = "block";
      })
      .finally(() => {
        // Reset button state
        resetBtn.disabled = false;
        resetBtn.textContent = 'Send Reset Link';
      });
  }

  // Advertisement Slider
  function startAdSlider() {
    const slides = document.querySelectorAll('.ad-slide');
    if (slides.length === 0) return; // No slides to animate

    let currentSlide = 0;

    // Clear existing interval if any
    if (adInterval) {
      clearInterval(adInterval);
    }

    // Ensure only the first slide is active initially
    slides.forEach((slide, index) => {
        slide.classList.toggle('active', index === 0);
    });


    adInterval = setInterval(() => {
      slides[currentSlide].classList.remove('active');
      currentSlide = (currentSlide + 1) % slides.length;
      slides[currentSlide].classList.add('active');
    }, 3000); // Change every 3 seconds
  }

  function stopAdSlider() {
      if (adInterval) {
          clearInterval(adInterval);
          adInterval = null;
      }
  }

  // Load all dashboard data from the provided snapshot
  function loadDashboardData(snapshot) {
    if (!currentUser) return; // Don't load if no user logged in

    const allUsers = [];
    if (snapshot.exists()) {
        snapshot.forEach((childSnapshot) => {
          const user = childSnapshot.val();
          user.id = childSnapshot.key; // Add Firebase key as ID
          // Basic data validation/defaults
          user.shares = user.shares || 0;
          user.name = user.name || 'Anonymous';
          user.email = user.email || '';
          allUsers.push(user);
        });
    } else {
        console.warn("No user data found in the database.");
        // Handle case with no users gracefully
         clearLoadingStates(); // Remove loading spinners
         document.getElementById('topInvestors').innerHTML = '<p>No investor data available.</p>';
         document.getElementById('totalInvestors').textContent = '0';
         // Potentially display a message in the profile too
         return;
    }


    // Find current user's data
    const currentUserData = allUsers.find(user => user.email === currentUser.email);

    // Process and display data
    displayTopInvestors(allUsers);
    if (currentUserData) {
      displayUserProfile(currentUserData);
      displayReturnPercentageCards(currentUserData.shares);
    } else {
      console.warn("Current user's data not found in the snapshot. Logging out.");
       // Handle case where logged-in user is not in DB (maybe deleted?)
      alert("Your user data could not be found. Logging out.");
      logoutUser(); // Log out the user as their data is missing
      return; // Stop further processing
    }
    updateSharesChart(allUsers);
    updateSharesSummary(allUsers);

    // Clear any remaining loading states just in case
    clearLoadingStates();

  }

  // Helper to remove all loading classes
  function clearLoadingStates() {
       document.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));
       // Specific loading text cleanup if needed
        if(document.getElementById('userShares').textContent === 'Loading...') document.getElementById('userShares').textContent = '0';
        if(document.getElementById('userInvestment').textContent === 'Loading...') document.getElementById('userInvestment').textContent = '₹0';
        if(document.getElementById('memberSince').textContent === 'Loading...') document.getElementById('memberSince').textContent = 'N/A';
        if(document.querySelector('#soldSharesCard .value').textContent === '...') document.querySelector('#soldSharesCard .value').textContent = '0';
        if(document.querySelector('#availableSharesCard .value').textContent === '...') document.querySelector('#availableSharesCard .value').textContent = '0';
        if(document.getElementById('totalInvestors').textContent === '...') document.getElementById('totalInvestors').textContent = '0';
  }

    // Display year-wise return percentage cards
  function displayReturnPercentageCards(userShares = 0) {
    const container = document.getElementById('returnPercentageCards');
    container.innerHTML = ''; // Clear previous cards
    const sharePrice = 100; // Assuming price per share

    const returns = [
      { years: 1, percentage: 8 },
      { years: 2, percentage: 20 },
      { years: 3, percentage: 50 },
      { years: 4, percentage: 75 },
      { years: 5, percentage: 110 }
    ];

    // Calculate base investment only once
    const investmentAmount = userShares * sharePrice;

    returns.forEach(ret => {
      const card = document.createElement('div');
      card.className = 'return-card';
      card.classList.add(`year-${ret.years}`); // Add class for year-specific styling

      const returnAmount = (investmentAmount * ret.percentage) / 100;
      const totalAmount = investmentAmount + returnAmount;

      card.innerHTML = `
        <h3>${ret.years} Year${ret.years > 1 ? 's' : ''}</h3>
        <div class="percentage">${ret.percentage}%</div>
        <div class="amount" title="Based on current ${userShares} shares (₹${investmentAmount.toFixed(0)})">≈ ₹${totalAmount.toFixed(2)}</div>
      `;
      container.appendChild(card);
    });
  }


    // Display top 3 investors
  function displayTopInvestors(allUsers) {
    const container = document.getElementById('topInvestors');
    container.innerHTML = ''; // Clear previous content/loading states

    // Sort by shares (descending) and take top 3
    const topInvestors = [...allUsers] // Create a copy before sorting
      .sort((a, b) => (b.shares || 0) - (a.shares || 0))
      .slice(0, 3);

    if (topInvestors.length === 0 && allUsers.length > 0) {
        // Handle case where users exist but have 0 shares
        container.innerHTML = '<p>No investors with shares yet.</p>';
        return;
    } else if (allUsers.length === 0) {
        // Handled in loadDashboardData, but good to double-check
        container.innerHTML = '<p>No investor data available.</p>';
        return;
    }


    topInvestors.forEach((investor, index) => {
      const investorCard = document.createElement('div');
      investorCard.className = 'investor-card'; // Base class with background

      // Use profilePic if available, otherwise use name initial
      const avatarContent = investor.profilePic ?
        `<img src="${investor.profilePic}" alt="${investor.name}" onerror="this.parentElement.innerHTML='${investor.name ? investor.name.charAt(0).toUpperCase() : '?'}'">` :
        (investor.name ? investor.name.charAt(0).toUpperCase() : '?');

      // *** Calculate amount ***
      const investmentValue = (investor.shares || 0) * 100;

      investorCard.innerHTML = `
        <div class="investor-avatar">
          ${avatarContent}
        </div>
        <div class="investor-details">
          <div class="investor-rank">#${index + 1}</div>
          <div class="investor-name">${investor.name || 'Anonymous'}</div>
          <div class="investor-shares">
            <i class="fas fa-coins"></i>
            ${investor.shares || 0} Shares
            <span class="investor-amount">(₹${investmentValue})</span>
          </div>
        </div>
      `;
      container.appendChild(investorCard);
    });

    // Optional: Fill remaining slots if less than 3 investors were found *with shares*
    // (This might not be needed if you only want to show actual top investors)
    // for (let i = topInvestors.length; i < 3; i++) {
    //   const placeholderCard = document.createElement('div');
    //   placeholderCard.className = 'investor-card placeholder'; // Add placeholder class for different styling if needed
    //   placeholderCard.innerHTML = `...`; // Simple placeholder content
    //   container.appendChild(placeholderCard);
    // }
  }




  // Display user profile
  function displayUserProfile(user) {
    const profileCard = document.getElementById('userProfile');
    // Clear loading classes from profile elements
    profileCard.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));

    document.querySelector('#userProfile .profile-name').textContent = user.name || 'Anonymous';
    document.querySelector('#userProfile .profile-id').textContent = `RMZID: ${user.rmzID || 'N/A'}`;

    // *** Format Mobile Number: Display only the number ***
    document.querySelector('#userProfile .profile-mobile').textContent = user.mobileNumber || 'Not Available';

    const userShares = user.shares || 0;
    const userInvestment = userShares * 100;
    document.getElementById('userShares').textContent = userShares;
    document.getElementById('userInvestment').textContent = `₹${userInvestment}`;
    document.getElementById('memberSince').textContent = formatDate(user.createdAt);

    // Set profile avatar
    const profileAvatar = document.querySelector('#userProfile .profile-avatar');
    profileAvatar.innerHTML = ''; // Clear previous content

    if (user.profilePic) {
      const img = document.createElement('img');
      img.src = user.profilePic;
      img.alt = user.name || 'Profile';
      img.onerror = () => handleProfileImageError(profileAvatar, user.name); // Pass avatar element and name
      profileAvatar.appendChild(img);
      profileAvatar.style.backgroundColor = 'transparent'; // Ensure no background color interferes
    } else {
        handleProfileImageError(profileAvatar, user.name); // Use fallback if no pic
    }
  }

  // Simple function to generate a fallback avatar background color
  function getAvatarBackgroundColor(name) {
    if (!name) return '#4361ee'; // Default primary color
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    const hue = hash % 360;
    return `hsl(${hue}, 60%, 55%)`; // Slightly adjusted saturation/lightness
  }

  // Handle profile image loading errors or missing images - Creates fallback initial
  function handleProfileImageError(avatarElement, name) {
    const initial = name ? name.charAt(0).toUpperCase() : '?';
    avatarElement.innerHTML = initial; // Set the initial as text content
    avatarElement.style.backgroundColor = getAvatarBackgroundColor(name);
    // Ensure styles for text display are set
    avatarElement.style.color = 'white';
    avatarElement.style.fontWeight = 'bold';
    avatarElement.style.fontSize = '2.5rem';
    avatarElement.style.display = 'flex';
    avatarElement.style.alignItems = 'center';
    avatarElement.style.justifyContent = 'center';
  }

  // Update shares distribution chart
  function updateSharesChart(users) {
    const ctx = document.getElementById('sharesChart').getContext('2d');

    // Destroy previous chart instance if it exists
    if (sharesChart) {
      sharesChart.destroy();
      sharesChart = null;
    }

    // Filter out users with 0 shares for a cleaner chart, sort, take top N
    const usersWithShares = users.filter(user => (user.shares || 0) > 0);
    usersWithShares.sort((a, b) => (b.shares || 0) - (a.shares || 0));

    const topN = 9; // Show top 9 investors in the chart
    const chartUsers = usersWithShares.slice(0, topN);

    const labels = chartUsers.map(user => user.name || 'Anonymous');
    const sharesData = chartUsers.map(user => user.shares || 0);
    const investmentData = sharesData.map(shares => shares * 100); // Calculate investment

    // Check if there's any data to chart
    if (chartUsers.length === 0) {
        // Optionally display a message if no data
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.textAlign = 'center';
        ctx.fillText('No share data to display.', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
    }


    sharesChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Shares Held',
            data: sharesData,
            backgroundColor: 'rgba(67, 97, 238, 0.7)', // Primary color with opacity
            borderColor: 'rgba(67, 97, 238, 1)',
            borderWidth: 1,
            yAxisID: 'yShares' // Assign to the primary Y axis
          },
          {
            label: 'Investment (₹)',
            data: investmentData,
            backgroundColor: 'rgba(76, 201, 240, 0.7)', // Success color with opacity
            borderColor: 'rgba(76, 201, 240, 1)',
            borderWidth: 2, // Slightly thicker border for line
            type: 'line', // Make this dataset a line chart
            yAxisID: 'yInvestment', // Assign to the secondary Y axis
            tension: 0.1 // Slight curve to the line
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
             ticks: {
                autoSkip: false, // Prevent labels from being skipped
                maxRotation: 45, // Rotate labels if they overlap
                minRotation: 0
             }
          },
          yShares: { // Primary Y Axis (Shares)
            position: 'left',
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of Shares'
            }
          },
          yInvestment: { // Secondary Y Axis (Investment)
            position: 'right',
            beginAtZero: true,
            title: {
              display: true,
              text: 'Investment Amount (₹)'
            },
            grid: {
              drawOnChartArea: false // Only draw grid lines for the primary axis
            }
          }
        },
        plugins: {
          tooltip: {
            mode: 'index', // Show tooltips for all datasets at that index
            intersect: false, // Tooltip appears even when not directly hovering over point/bar
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.dataset.yAxisID === 'yShares') { // Shares dataset
                  label += context.formattedValue + ' shares';
                } else if (context.dataset.yAxisID === 'yInvestment') { // Investment dataset
                  label += '₹' + context.formattedValue;
                }
                return label;
              }
            }
          },
          legend: {
             position: 'top', // Position legend at the top
          }
        }
      }
    });
  }

// Update shares summary with progress bars
  function updateSharesSummary(users) {
    const totalShares = 1000; // Total available shares
    let soldShares = 0;

    users.forEach(user => {
      soldShares += user.shares || 0;
    });

    // Ensure sold shares don't exceed total shares (data sanity check)
    soldShares = Math.min(soldShares, totalShares);

    const availableShares = totalShares - soldShares;
    const soldPercentage = totalShares > 0 ? (soldShares / totalShares) * 100 : 0;
    const availablePercentage = 100 - soldPercentage;

    // Update text values (remove loading class handled elsewhere now)
    document.querySelector('#soldSharesCard .value').textContent = soldShares;
    document.querySelector('#availableSharesCard .value').textContent = availableShares;
    document.getElementById('totalInvestors').textContent = users.length;

    // Update progress bars smoothly
    const soldProgressBar = document.querySelector('#soldProgress .progress-bar');
    const availableProgressBar = document.querySelector('#availableProgress .progress-bar');

    soldProgressBar.style.width = `${soldPercentage}%`;
    availableProgressBar.style.width = `${availablePercentage}%`;
  }

  // Helper function to format date (e.g., "April 6, 2025")
  function formatDate(timestamp) {
    if (!timestamp) return 'N/A';
    try {
      const date = new Date(timestamp);
      // Check if date is valid
      if (isNaN(date.getTime())) return 'Invalid Date';
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    } catch (e) {
        console.error("Error formatting date:", timestamp, e);
        return 'Invalid Date';
    }
  }

  // --- Authentication State Change Listener ---
  auth.onAuthStateChanged((user) => {
    // Ensure modals are hidden on auth state change
    hideForgotPassword();
    closeChangePasswordModal();
    closeNotificationsModal();

    if (user) {
      // User is signed in.
      currentUser = user;
      loginScreen.style.display = 'none'; // Hide login
      dashboardScreen.style.display = 'block'; // Show dashboard
      console.log("Auth state changed: User logged in", user.email);
      setupRealtimeListener(); // Start listening for data
      startAdSlider(); // Start ad slider
      // Initial load might be triggered by the listener setup, or call explicitly if needed
      // loadDashboardData(); // Could call here, but listener should handle it
    } else {
      // User is signed out.
      currentUser = null;
      dashboardScreen.style.display = 'none'; // Hide dashboard
      loginScreen.style.display = 'flex'; // Show login
      console.log("Auth state changed: User logged out");
      stopAdSlider(); // Stop ad slider
       // Detach listeners when logged out
       if (usersRef) usersRef.off();
       if (notificationsRef) notificationsRef.off();
       // Clear dashboard data visually if needed
       clearLoadingStates(); // Optional: reset UI elements
       document.getElementById('topInvestors').innerHTML = ''; // Clear lists etc.
       document.getElementById('returnPercentageCards').innerHTML = '';
       if(sharesChart) sharesChart.destroy(); sharesChart = null; // Clear chart
    }
  });

  // --- Initial Setup ---
  // Code inside onAuthStateChanged handles the initial view (login or dashboard)

</script>
</body>
</html>
