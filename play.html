<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡§¨‡•à‡§Ç‡§ï ‡§ö‡•à‡§ü‡§¨‡•â‡§ü (Firebase)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- Base Styles --- */
        :root {
            --primary-color: #45a049;
            --primary-darker: #3c8e40;
            --secondary-color: #f4f6f8;
            --user-message-bg: #e2ffc7;
            --bot-message-bg: #ffffff;
            --text-dark: #212529;
            --text-light: #5a6a79;
            --border-color: #e0e0e0;
            --suggestion-bg: #e9f5e9;
            --suggestion-hover-bg: #d8eed8;
            --prime-member-bg: #ffc107;
            --prime-member-text: #000000;
            --loan-highlight-color: #dc3545;
            --header-height: 60px;
            --input-area-min-height: 60px;
            --border-radius: 10px;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --message-shadow: 0 2px 5px rgba(0, 0, 0, 0.06);
            --pill-suggestion-bg: #f0f0f0;
            --pill-suggestion-text: #333;
            --pill-suggestion-hover-bg: #e0e0e0;
            --suggestion-bubble-bg: var(--bot-message-bg);
            --suggestion-bubble-border: var(--border-color);
            --suggestion-bubble-padding: 12px 15px;
            --suggestion-bubble-radius: 18px;
            --suggestion-bubble-max-width: 90%;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: 'Segoe UI', 'Roboto', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--secondary-color); overflow: hidden; font-size: 16px; }

        /* --- Layout Containers --- */
        .chat-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 800px; margin: 0 auto; background: var(--bot-message-bg); box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1); border-radius: 0; }
        @media (min-width: 801px) { .chat-container { height: 90vh; max-height: 750px; margin: 25px auto; border-radius: var(--border-radius); overflow: hidden; } }

        .chat-header { height: var(--header-height); background: linear-gradient(135deg, var(--primary-color), var(--primary-darker)); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.3em; font-weight: 600; padding: 0 20px; flex-shrink: 0; border-top-left-radius: inherit; border-top-right-radius: inherit; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .chat-header .icon { margin-right: 12px; font-size: 1.6em; }

        .chat-messages { flex-grow: 1; padding: 20px 15px; overflow-y: auto; background-color: var(--secondary-color); display: flex; flex-direction: column; gap: 5px; }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .chat-messages::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 3px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* --- Message Bubbles --- */
        .message { padding: 14px 20px; border-radius: 18px; line-height: 1.65; word-wrap: break-word; max-width: var(--suggestion-bubble-max-width); position: relative; box-shadow: var(--message-shadow); font-size: 0.98em; margin-bottom: 10px; }
        .message a { color: #0066cc; text-decoration: underline; } .message a:hover { color: #004c99; }
        .message p { margin-bottom: 10px; } .message p:last-child { margin-bottom: 0; }
        .message ul, .message ol { margin-left: 20px; margin-bottom: 10px; padding-left: 15px; } .message ul li { margin-bottom: 6px; }

        .user { align-self: flex-end; background-color: var(--user-message-bg); color: var(--text-dark); border-bottom-right-radius: 6px; }
        .bot { align-self: flex-start; background-color: var(--bot-message-bg); color: var(--text-dark); border: 1px solid var(--border-color); border-bottom-left-radius: 6px; }
        .bot.typing { color: var(--text-light); font-style: italic; background-color: transparent; border: none; box-shadow: none; padding-left: 0; margin-bottom: 10px; }

        /* --- User Details Card --- */
        .user-details-card { padding: 20px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: #ffffff; margin-top: 8px; box-shadow: var(--card-shadow); box-sizing: border-box; }
        .user-details-header { display: flex; align-items: center; gap: 18px; margin-bottom: 18px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .profile-pic-container { position: relative; flex-shrink: 0; width: 80px; height: 80px; }
        .profile-pic { width: 100%; height: 100%; object-fit: cover; border-radius: 10%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.15); background-color: #eee; }
        .prime-tag-on-photo { position: absolute; top: -6px; right: -6px; background-color: var(--prime-member-bg); color: var(--prime-member-text); font-size: 0.75em; font-weight: bold; padding: 4px 8px; border-radius: 6px; line-height: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 1; }
        .user-info { flex-grow: 1; }
        .user-info h3 { margin: 0; font-size: 1.3em; color: var(--text-dark); font-weight: 600; }
        .user-info p { margin: 5px 0 0; font-size: 0.9em; color: var(--text-light); }
        .user-info .label { font-weight: 500; }
        .user-stats { padding-top: 15px; }
        .user-stats p { margin-bottom: 12px; font-size: 0.98em; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px 10px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .user-stats p:last-child { border-bottom: none; margin-bottom: 0; }
        .user-stats .label { color: var(--text-light); margin-right: 8px; display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .user-stats .value { font-weight: 600; text-align: right; flex-grow: 1; word-break: break-word; }
        .user-stats .label .icon { font-size: 1.1em; opacity: 0.7; }
        .loan-highlight { color: var(--loan-highlight-color); font-weight: 700; }
        .sip-status { font-weight: bold; padding: 3px 8px; border-radius: 5px; font-size: 0.9em; display: inline-block; }
        .sip-status.paid { color: #fff; background-color: #28a745; }
        .sip-status.pending { color: #fff; background-color: var(--loan-highlight-color); }
        .sip-status.due { color: #333; background-color: #ffc107; }

        /* --- Clickable Member List --- */
        .member-list-container { padding: 10px 0; max-height: 220px; overflow-y: auto; }
        .clickable-member { display: block; padding: 10px 15px; margin-bottom: 5px; background-color: #f8f9fa; border-radius: 6px; cursor: pointer; color: var(--text-dark); text-decoration: none; transition: background-color 0.2s ease, color 0.2s ease; font-size: 0.98em; border: 1px solid var(--border-color); }
        .clickable-member:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-darker); }

        /* --- Suggestion Blocks --- */
        .suggestion-group { background-color: var(--bot-message-bg); border: 1px solid var(--border-color); padding: 18px; margin-top: 0px; border-radius: 15px; align-self: flex-start; max-width: 90%; box-shadow: var(--message-shadow); margin-bottom: 10px; }
        .suggestion-group .group-title { font-weight: 600; margin-bottom: 14px; color: var(--text-light); font-size: 0.9em; }
        .chat-suggestion { display: block; background-color: var(--suggestion-bg); color: var(--primary-color); padding: 11px 16px; border-radius: 8px; cursor: pointer; font-size: 0.92em; margin-bottom: 8px; border: 1px solid #d0e0d0; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease; text-align: left; font-weight: 500; }
        .chat-suggestion:hover { background-color: var(--suggestion-hover-bg); border-color: #b0c0b0; transform: translateY(-1px); }
        .chat-suggestion:last-child { margin-bottom: 0; }

        .suggestion-bubble { background-color: var(--suggestion-bubble-bg); border: 1px solid var(--suggestion-bubble-border); border-radius: var(--suggestion-bubble-radius); padding: var(--suggestion-bubble-padding); display: flex; flex-wrap: wrap; gap: 8px; width: fit-content; max-width: var(--suggestion-bubble-max-width); align-self: flex-start; box-shadow: var(--message-shadow); margin-top: -5px; margin-bottom: 10px; position: relative; align-items: center; }
        .inline-suggestion-pill { background-color: var(--pill-suggestion-bg); color: var(--pill-suggestion-text); padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 0.88em; border: 1px solid #dcdcdc; transition: background-color 0.2s ease, border-color 0.2s ease; line-height: 1.4; white-space: nowrap; text-align: center; }
        .inline-suggestion-pill:hover { background-color: var(--pill-suggestion-hover-bg); border-color: #c0c0c0; }

        /* --- Input Area --- */
        .chat-input-area { min-height: var(--input-area-min-height); display: flex; align-items: flex-end; border-top: 1px solid var(--border-color); background-color: #ffffff; padding: 10px 12px; flex-shrink: 0; position: relative; border-bottom-left-radius: inherit; border-bottom-right-radius: inherit; gap: 10px; }
        .chat-input-area textarea { flex-grow: 1; padding: 10px 18px; border: 1px solid var(--border-color); border-radius: 20px; font-size: 1em; font-family: inherit; line-height: 1.4; outline: none; transition: border-color 0.2s ease, box-shadow 0.2s ease; resize: none; overflow-y: auto; min-height: calc(1em * 1.4 + 2 * 10px + 2px); max-height: calc(1em * 1.4 * 5 + 2 * 10px + 2px); }
        .chat-input-area textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(69, 160, 73, 0.2); }
        .chat-input-area button { height: calc(1em * 1.4 + 2 * 10px + 2px); padding: 0 22px; border: none; background: var(--primary-color); color: white; cursor: pointer; font-size: 1em; font-weight: 600; border-radius: 20px; transition: background-color 0.2s ease; flex-shrink: 0; align-self: flex-end; }
        .chat-input-area button:hover { background: var(--primary-darker); }

        /* --- Autocomplete Suggestions --- */
        .suggestions { position: absolute; bottom: calc(var(--input-area-min-height) + 8px); left: 12px; right: 12px; display: flex; flex-direction: column; gap: 6px; padding: 12px; background: #ffffff; border: 1px solid var(--border-color); max-height: 220px; overflow-y: auto; z-index: 100; box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1); border-radius: 8px; }
        .suggestion { background: #f1f1f1; color: var(--text-dark); padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 0.9em; text-align: left; border: 1px solid transparent; transition: background-color 0.2s ease; }
        .suggestion:hover { background: #e0e0e0; }

        /* --- Image Modal --- */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.88); justify-content: center; align-items: center; }
        .modal-content { margin: auto; display: block; max-width: 90%; max-height: 90%; border-radius: 5px; }
        .modal-close { position: absolute; top: 25px; right: 40px; color: #f1f1f1; font-size: 45px; font-weight: bold; transition: 0.3s; cursor: pointer; line-height: 1; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .modal-close:hover, .modal-close:focus { color: #bbb; text-decoration: none; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <span class="icon">üè¶</span>‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§ö‡•à‡§ü‡§¨‡•â‡§ü (Firebase) üí¨
    </div>
    <div class="chat-messages" id="chat">
        <div class="message bot">
            ‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§≤‡•ã‡§® ‡§Ø‡•ã‡§ú‡§®‡§æ, ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£, ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ, ‡§®‡§ø‡§Ø‡§Æ‡•ã‡§Ç ‡§î‡§∞ ‡§Ö‡§®‡•ç‡§Ø ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å‡•§ ‡§Ü‡§™ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡•á‡§Ç, ‡§Æ‡•à‡§Ç ‡§∏‡§Æ‡§ù‡§®‡•á ‡§î‡§∞ ‡§∏‡§π‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§®‡•á ‡§ï‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•Ç‡§Å‡§ó‡§æ‡•§
        </div>
        <div class="message bot suggestion-group initial-suggestions">
             <div class="group-title">‡§Ü‡§™ ‡§á‡§∏ ‡§§‡§∞‡§π ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:</div>
             <div class="chat-suggestion" onclick="triggerSend('‡§Æ‡•á‡§∞‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡§ø‡§§‡§®‡§æ ‡§π‡•à?')">‡§Æ‡•á‡§∞‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡§ø‡§§‡§®‡§æ ‡§π‡•à?</div>
             <div class="chat-suggestion" onclick="triggerSend('SIP ‡§≠‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§ñ‡§ø‡§∞‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?')">SIP ‡§≠‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§ñ‡§ø‡§∞‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?</div>
             <div class="chat-suggestion" onclick="triggerSend('Raja Sahni ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡§ø‡§ñ‡§æ‡§ì')">Raja Sahni ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡§ø‡§ñ‡§æ‡§ì</div>
             <div class="chat-suggestion" onclick="triggerSend('‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§ì')">‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§ì</div>
        </div>
    </div>
    <div class="suggestions" id="suggestions" style="display:none;"></div>
    <div class="chat-input-area">
        <textarea id="input" placeholder="‡§Ö‡§™‡§®‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç..." rows="1" oninput="autoGrow(this)" onkeydown="handleKey(event)" autocomplete="off"></textarea>
        <button onclick="send()" aria-label="‡§≠‡•á‡§ú‡•á‡§Ç">‡§≠‡•á‡§ú‡•á‡§Ç</button>
    </div>
</div>

<div id="imageModal" class="modal-overlay">
    <span class="modal-close" onclick="closeImageModal()">&times;</span>
    <img class="modal-content" id="modalImageContent">
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// --- 1. CONFIGURATION & GLOBAL STATE ---

// !! ‡§ú‡§∞‡•Ç‡§∞‡•Ä: ‡§Ö‡§™‡§®‡•Ä Firebase ‡§î‡§∞ Gemini API Keys ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç !!
const firebaseConfig = {
  apiKey: "AIzaSyBVCDW0Q8YaTPz_MO9FTve1FaPu42jtO2c", // ‡§Ü‡§™‡§ï‡•Ä Firebase API Key
  authDomain: "bank-master-data.firebaseapp.com",
  databaseURL: "https://bank-master-data-default-rtdb.asia-southeast1.firebasedatabase.app", // ‡§Ü‡§™‡§ï‡§æ Database URL
  projectId: "bank-master-data",
  storageBucket: "bank-master-data.appspot.com",
  messagingSenderId: "778113641069",
  appId: "1:778113641069:web:f2d584555dee89b8ca2d64"
};
const API_KEY = "AIzaSyC-Mskcg8GLdfPvrvIzs7NfrIn3TxpOYAw"; // ‡§Ü‡§™‡§ï‡•Ä Gemini API Key

// Firebase ‡§ï‡•ã ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ‡§ï‡§∞‡•á‡§Ç
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const defaultProfilePic = 'https://via.placeholder.com/100/CCCCCC/FFFFFF?text=üë§';
const primeMembers = ["Amit Kumar", "Mithilesh Sahni", "Prince Rama"]; // ‡§á‡§∏‡•á Firebase ‡§∏‡•á ‡§≠‡•Ä ‡§≤‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à
const MAX_TEXTAREA_LINES = 5;

// Global Cache - Firebase ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§π‡•ã‡§ó‡§æ
let cachedMembersData = null; // '/members' ‡§®‡•ã‡§° ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ
let cachedRulesData = null;   // '/admin/faqs' ‡§®‡•ã‡§° ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ (‡§Ø‡§π ‡§è‡§ï ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§®‡•ã‡§° ‡§π‡•à)
let isFetchingData = false;
let lastBotMessageElement = null;

// --- DOM Elements ---
const chatBox = document.getElementById("chat");
const inputBox = document.getElementById("input");
const suggestionsBox = document.getElementById("suggestions");
const imageModal = document.getElementById("imageModal");
const modalImageContent = document.getElementById("modalImageContent");

// --- 2. UTILITY & UI FUNCTIONS (Largely Unchanged) ---
function formatDate(date, options = {}) {
    if (!(date instanceof Date) || isNaN(date)) return "--";
    const defaultOptions = { day: '2-digit', month: 'short', year: 'numeric' };
    return date.toLocaleDateString('en-GB', { ...defaultOptions, ...options });
}

function appendMessage(content, cls, isHtml = false) {
    const d = document.createElement("div");
    d.className = "message " + cls;
    if (isHtml) {
        d.innerHTML = content.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
    } else {
        d.textContent = content;
    }
    chatBox.appendChild(d);
    if (cls.includes('bot') && !cls.includes('typing')) {
        lastBotMessageElement = d;
    }
    setTimeout(() => scrollToBottom(), 50);
    return d;
}

function appendInlineSuggestions(suggestions) {
    if (!suggestions || !Array.isArray(suggestions) || suggestions.length === 0) return;
    const oldBubbles = chatBox.querySelectorAll('.suggestion-bubble');
    oldBubbles.forEach(el => el.remove());
    
    const bubbleContainer = document.createElement('div');
    bubbleContainer.className = 'message bot suggestion-bubble';
    suggestions.slice(0, 6).forEach(q_text => {
        if (typeof q_text !== 'string' || !q_text) return;
        const pill = document.createElement('div');
        pill.className = 'inline-suggestion-pill';
        pill.textContent = q_text;
        pill.onclick = () => triggerSend(q_text);
        bubbleContainer.appendChild(pill);
    });
    if (bubbleContainer.children.length > 0) {
        chatBox.appendChild(bubbleContainer);
        setTimeout(() => scrollToBottom(), 150);
    }
}

function typeEffect(text, targetElement, callback = null) {
    let i = 0;
    targetElement.innerHTML = '&nbsp;';
    const interval = setInterval(() => {
        if (i < text.length) {
            targetElement.textContent = text.substring(0, i + 1);
            i++;
        } else {
            clearInterval(interval);
            if (typeof callback === 'function') setTimeout(callback, 150);
        }
    }, 25);
}

function scrollToBottom() {
    requestAnimationFrame(() => {
        if (chatBox) chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    });
}

function autoGrow(element) {
  element.style.height = 'auto';
  const computedStyle = window.getComputedStyle(element);
  const lineHeight = parseFloat(computedStyle.lineHeight);
  const maxHeight = (lineHeight * MAX_TEXTAREA_LINES) + (parseFloat(computedStyle.paddingTop) * 2);
  element.style.height = `${Math.min(element.scrollHeight, maxHeight)}px`;
}

function openImageModal(imageUrl) {
    if (imageUrl && !imageUrl.includes('via.placeholder.com')) {
        modalImageContent.src = imageUrl;
        imageModal.style.display = "flex";
    }
}

function closeImageModal() {
    imageModal.style.display = "none";
    modalImageContent.src = "";
}

function triggerSend(text) {
    inputBox.value = text;
    send();
    inputBox.style.height = 'auto';
    autoGrow(inputBox);
    suggestionsBox.style.display = 'none';
    const inlineSuggestions = chatBox.querySelectorAll('.suggestion-bubble');
    inlineSuggestions.forEach(el => el.remove());
}

// --- 3. FIREBASE DATA FETCHING & PROCESSING ---

/**
 * Firebase ‡§∏‡•á ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§î‡§∞ ‡§®‡§ø‡§Ø‡§Æ ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§â‡§∏‡•á ‡§ï‡•à‡§∂ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
 * ‡§Ø‡§π Google Sheets ‡§µ‡§æ‡§≤‡•á ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§§‡§æ ‡§π‡•à‡•§
 */
async function fetchFirebaseData() {
    if (isFetchingData) {
        console.log("‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à, ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...");
        await new Promise(resolve => setTimeout(resolve, 500));
        return cachedMembersData !== null;
    }
    if (cachedMembersData) return true; // ‡§°‡•á‡§ü‡§æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§ï‡•à‡§∂ ‡§Æ‡•á‡§Ç ‡§π‡•à

    isFetchingData = true;
    console.log("Firebase ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...");
    const loadingMsg = appendMessage("‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...", "bot typing");

    try {
        // ‡§è‡§ï ‡§∏‡§æ‡§• members ‡§î‡§∞ admin/faqs ‡§®‡•ã‡§°‡•ç‡§∏ ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
        const membersRef = database.ref('members');
        // ‡§®‡•ã‡§ü: ‡§π‡§Æ‡§®‡•á ‡§Æ‡§æ‡§®‡§æ ‡§π‡•à ‡§ï‡§ø ‡§®‡§ø‡§Ø‡§Æ/FAQ 'admin/faqs' ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§π‡•à‡§Ç‡•§
        // ‡§Ø‡§¶‡§ø ‡§Ø‡§π ‡§ï‡§π‡•Ä‡§Ç ‡§î‡§∞ ‡§π‡•à, ‡§§‡•ã ‡§á‡§∏ ‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§ï‡•ã ‡§¨‡§¶‡§≤‡•á‡§Ç‡•§
        const rulesRef = database.ref('admin/faqs'); 

        const [membersSnapshot, rulesSnapshot] = await Promise.all([
            membersRef.once('value'),
            rulesRef.once('value')
        ]);

        cachedMembersData = membersSnapshot.val() || {};
        cachedRulesData = rulesSnapshot.val() || []; // ‡§Æ‡§æ‡§® ‡§≤‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π ‡§è‡§ï ‡§ê‡§∞‡•á ‡§π‡•à

        console.log(`Firebase ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü‡•§ ‡§∏‡§¶‡§∏‡•ç‡§Ø: ${Object.keys(cachedMembersData).length}, ‡§®‡§ø‡§Ø‡§Æ: ${cachedRulesData.length}`);
        loadingMsg?.remove();
        return true;
    } catch (error) {
        console.error("Firebase ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
        cachedMembersData = null;
        cachedRulesData = [];
        loadingMsg?.remove();
        appendMessage(`‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ‡•§ (${error.message})`, "bot");
        appendInlineSuggestions(["‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç", "‡§∏‡§π‡§æ‡§Ø‡§§‡§æ"]);
        return false;
    } finally {
        isFetchingData = false;
    }
}

/**
 * ‡§ï‡§ø‡§∏‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§ï‡•á ‡§è‡§ï‡§§‡•ç‡§∞‡§ø‡§§ ‡§°‡•á‡§ü‡§æ ‡§¶‡•á‡§§‡§æ ‡§π‡•à‡•§
 * ‡§Ø‡§π Firebase ‡§°‡•á‡§ü‡§æ ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§®‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§
 */
function getUserDataAggregated(name) {
    if (!cachedMembersData) {
        console.warn("‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à‡•§");
        return null;
    }

    const lowerName = name.toLowerCase().trim();
    let foundMember = null;
    let memberId = null;

    // ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•ã ‡§â‡§∏‡§ï‡•á ‡§™‡•Ç‡§∞‡•á ‡§®‡§æ‡§Æ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç
    for (const id in cachedMembersData) {
        const member = cachedMembersData[id];
        if (member.fullName && member.fullName.toLowerCase().trim() === lowerName) {
            foundMember = member;
            memberId = id;
            break;
        }
    }

    if (!foundMember) return null;

    let totalSIP = 0, totalLoan = 0, totalPayment = 0;
    let lastLoanDate = null, latestLoanAmount = 0;
    
    const transactions = foundMember.transactions ? Object.values(foundMember.transactions) : [];
    transactions.sort((a, b) => new Date(a.Date) - new Date(b.Date)); // ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ï‡•ã ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ï‡•ç‡§∞‡§Æ‡§¨‡§¶‡•ç‡§ß ‡§ï‡§∞‡•á‡§Ç

    transactions.forEach(tx => {
        totalSIP += parseFloat(tx['SIP Payment']) || 0;
        totalLoan += parseFloat(tx.Loan) || 0;
        totalPayment += parseFloat(tx['Loan Payment']) || 0;

        const txDate = new Date(tx.Date);
        if ((parseFloat(tx.Loan) || 0) > 0) {
            if (!lastLoanDate || txDate > lastLoanDate) {
                lastLoanDate = txDate;
                latestLoanAmount = parseFloat(tx.Loan);
            }
        }
    });
    
    // ‡§π‡§æ‡§≤‡§ø‡§Ø‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡•ã‡§® ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç
    let hasUnclearedLoan = false;
    if (lastLoanDate) {
        const paymentExistsAfterLoan = transactions.some(tx => 
            (parseFloat(tx['Loan Payment']) || 0) > 0 && new Date(tx.Date) > lastLoanDate
        );
        hasUnclearedLoan = !paymentExistsAfterLoan;
    }
    if (!hasUnclearedLoan) { latestLoanAmount = 0; }

    const overallBalance = (totalSIP + totalPayment) - totalLoan;
    const netLoanOutstanding = Math.max(0, totalLoan - totalPayment);
    const sipStatusInfo = getSipStatus(transactions);
    const isPrime = primeMembers.some(pm => pm.toLowerCase() === foundMember.fullName.toLowerCase());

    return {
        name: foundMember.fullName,
        totalSIP,
        totalLoan,
        totalPayment,
        overallBalance,
        netLoanOutstanding,
        imageUrl: foundMember.profilePicUrl || defaultProfilePic,
        joinDate: formatDate(new Date(foundMember.joiningDate)),
        sipStatusText: sipStatusInfo.statusText,
        sipStatusClass: sipStatusInfo.statusClass,
        hasUnclearedLoan,
        latestUnclearedLoanAmount: hasUnclearedLoan ? latestLoanAmount : 0,
        isPrimeMember: isPrime
    };
}

function getSipStatus(transactions) {
    if (!transactions || transactions.length === 0) return { statusText: "N/A", statusClass: "" };
    
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    const paidThisMonth = transactions.some(tx => {
        const txDate = new Date(tx.Date);
        return (parseFloat(tx['SIP Payment']) || 0) > 0 &&
               txDate.getMonth() === currentMonth &&
               txDate.getFullYear() === currentYear;
    });

    if (paidThisMonth) return { statusText: "Paid", statusClass: "paid" };
    if (now.getDate() > 10) return { statusText: "Pending", statusClass: "pending" };
    return { statusText: "Due", statusClass: "due" };
}

function calculateEligibility(userName, userBalance) {
    if (!cachedMembersData) return { isEligible: false, approvedAmount: 0, reason: "‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü" };

    // ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§ï‡§æ ‡§ï‡•Å‡§≤ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§∏‡•á ‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç
    let communityBalance = 0;
    Object.values(cachedMembersData).forEach(member => {
        if (member.transactions) {
            Object.values(member.transactions).forEach(tx => {
                communityBalance += (parseFloat(tx['SIP Payment']) || 0) + (parseFloat(tx['Loan Payment']) || 0) - (parseFloat(tx.Loan) || 0);
            });
        }
    });

    const isEligible = userBalance > 0 && communityBalance > 0;
    let approvedAmount = 0, reason = "";
    if (isEligible) {
        const potentialAmount = userBalance * 1.5;
        approvedAmount = Math.floor(Math.min(potentialAmount, communityBalance));
        reason = approvedAmount > 0 ? "" : "(‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§Æ‡•á‡§Ç ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§ ‡§´‡§Ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à)";
    } else {
        if (userBalance <= 0) reason = `(‡§Ü‡§™‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§∂‡•Ç‡§®‡•ç‡§Ø ‡§Ø‡§æ ‡§ã‡§£‡§æ‡§§‡•ç‡§Æ‡§ï ‡§π‡•à: ‚Çπ${userBalance.toFixed(0)})`;
        else reason = "(‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§Æ‡•á‡§Ç ‡§´‡§Ç‡§° ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à)";
    }
    return { isEligible: isEligible && approvedAmount > 0, approvedAmount, reason };
}


// --- 4. MAIN SEND FUNCTION (Adapted for Firebase) ---
async function send() {
    const query = inputBox.value.trim();
    if (!query) return;

    appendMessage(query, "user");
    inputBox.value = '';
    autoGrow(inputBox);
    suggestionsBox.style.display = 'none';
    chatBox.querySelectorAll('.suggestion-bubble').forEach(el => el.remove());

    const typingIndicator = appendMessage("‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...", "bot typing");

    // --- Step 1: Ensure Firebase data is loaded ---
    const dataReady = await fetchFirebaseData();
    if (!dataReady) {
        typingIndicator?.remove();
        // fetchFirebaseData function already shows an error message.
        return;
    }

    // --- Step 2: Prepare context for Gemini ---
    const memberNamesList = cachedMembersData ? Object.values(cachedMembersData).map(m => m.fullName).filter(Boolean) : [];
    
    // ‡§®‡•ã‡§ü: ‡§®‡§ø‡§Ø‡§Æ ‡§Ö‡§¨ cachedRulesData ‡§∏‡•á ‡§Ü ‡§∞‡§π‡•á ‡§π‡•à‡§Ç, ‡§ú‡•ã 'admin/faqs' ‡§∏‡•á ‡§Ü‡§§‡§æ ‡§π‡•à‡•§
    // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™‡§ï‡•á Firebase ‡§Æ‡•á‡§Ç ‡§á‡§∏ ‡§™‡§• ‡§™‡§∞ ‡§°‡•á‡§ü‡§æ ‡§π‡•à‡•§
    // ‡§°‡•á‡§ü‡§æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™: [{ question: "...", answer: "..." }, ...]
    let allRulesAndFaqsContext = "‡§ï‡•ã‡§à ‡§®‡§ø‡§Ø‡§Æ ‡§Ø‡§æ FAQ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§";
    if (cachedRulesData && cachedRulesData.length > 0) {
        allRulesAndFaqsContext = cachedRulesData.map((seg, index) => {
            return `${index + 1}. ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: ${seg.question}\n   ‡§â‡§§‡•ç‡§§‡§∞: ${seg.answer}`;
        }).join('\n\n');
    }

    const knownNamesString = memberNamesList.length > 0 ? memberNamesList.join(', ') : "‡§ï‡•ã‡§à ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü";
    const possibleIntents = ["get_rule", "get_member_specific_data", "list_all_members", "get_member_count", "greet", "thank_you", "general_query"];
    const possibleDetailTypes = ["full_details", "balance", "loan_eligibility", "sip_status", "outstanding_loan"];

    const prompt = `
‡§Ü‡§™ '‡§¨‡•à‡§Ç‡§ï ‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä ‡§ö‡•à‡§ü‡§¨‡•â‡§ü' ‡§π‡•à‡§Ç‡•§ ‡§Ü‡§™‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ø‡§æ ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§®‡§æ ‡§î‡§∞ ‡§∏‡§ü‡•Ä‡§ï, ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§, ‡§î‡§∞ ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§®‡§æ ‡§π‡•à‡•§

‡§®‡§ø‡§Ø‡§Æ/FAQ ‡§°‡•á‡§ü‡§æ:
--- RULES START ---
${allRulesAndFaqsContext}
--- RULES END ---

‡§ú‡•ç‡§û‡§æ‡§§ ‡§∏‡§¶‡§∏‡•ç‡§Ø: ${knownNamesString}

‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: "${query}"

‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø:
1.  ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§á‡§∞‡§æ‡§¶‡§æ (intent) ‡§™‡§π‡§ö‡§æ‡§®‡•á‡§Ç‡•§ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§á‡§∞‡§æ‡§¶‡•á: ${possibleIntents.join(', ')}.
2.  ‡§Ø‡§¶‡§ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§ø‡§∏‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§π‡•à, ‡§§‡•ã ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ (member_name) ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç‡•§ ‡§Ø‡§¶‡§ø ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡•ç‡§µ‡§Ø‡§Ç ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ ‡§∞‡§π‡§æ ‡§π‡•à (‡§ú‡•à‡§∏‡•á '‡§Æ‡•á‡§∞‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏'), ‡§§‡•ã member_name ‡§ï‡•ã "self" ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§
3.  ‡§Ø‡§¶‡§ø ‡§á‡§∞‡§æ‡§¶‡§æ 'get_member_specific_data' ‡§π‡•à, ‡§§‡•ã ‡§™‡§π‡§ö‡§æ‡§®‡•á‡§Ç ‡§ï‡§ø ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•å‡§® ‡§∏‡•Ä ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä (detail_type) ‡§ö‡§æ‡§π‡§§‡§æ ‡§π‡•à‡•§ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞: ${possibleDetailTypes.join(', ')}. ‡§Ø‡§¶‡§ø ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à ('‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡§ø‡§ñ‡§æ‡§ì'), ‡§§‡•ã 'full_details' ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§
4.  JSON ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§≤‡•å‡§ü‡§æ‡§è‡§Ç:
    {
      "intent": "[intent]",
      "member_name": "[name / 'self' / null]",
      "detail_type": "[detail_type / 'full_details' / null]",
      "answer": "[rule_answer_rephrased_by_you / general_answer_rephrased_by_you / null]",
      "confidence": "[high/medium/low]"
    }

‡§ï‡•á‡§µ‡§≤ JSON ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç:
`;

    // --- Step 3: Call Gemini API ---
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
    let analysisResult = null;

    try {
        console.log("Gemini ‡§ï‡•ã ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à:", query);
        const response = await fetch(GEMINI_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { temperature: 0.2, maxOutputTokens: 700, responseMimeType: "application/json" },
                safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" } ]
            }),
        });
        typingIndicator?.remove();

        if (!response.ok) throw new Error(`API Error ${response.status}`);
        const js = await response.json();
        
        if (!js.candidates?.[0]?.content?.parts?.[0]?.text) {
            if (js.promptFeedback?.blockReason) throw new Error(`Content Blocked (${js.promptFeedback.blockReason})`);
            throw new Error("API ‡§∏‡•á ‡§ï‡•ã‡§à ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§");
        }
        
        const rawJsonText = js.candidates[0].content.parts[0].text;
        console.log("Gemini ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ Raw JSON:", rawJsonText);
        analysisResult = JSON.parse(rawJsonText.replace(/^```json\s*/, '').replace(/\s*```$/, ''));
        console.log("Parsed Analysis Result:", analysisResult);

    } catch (error) {
        typingIndicator?.remove();
        console.error("Gemini ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
        appendMessage(`‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ (${error.message})`, "bot");
        appendInlineSuggestions(["‡§ï‡•ã‡§à ‡§¶‡•Ç‡§∏‡§∞‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡•á‡§Ç", "‡§®‡§ø‡§Ø‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì"]);
        return;
    }

    // --- Step 4: Handle Based on Intent ---
    handleIntent(analysisResult, memberNamesList, allRulesAndFaqsContext);
}

/**
 * Gemini ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§á‡§∞‡§æ‡§¶‡•á ‡§ï‡•ã ‡§∏‡§Ç‡§≠‡§æ‡§≤‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§â‡§ö‡§ø‡§§ ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
 */
function handleIntent(analysisResult, memberNamesList, rulesContext) {
    if (!analysisResult || !analysisResult.intent) {
        appendMessage("‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•á ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡•ã ‡§∏‡§Æ‡§ù ‡§®‡§π‡•Ä‡§Ç ‡§™‡§æ‡§Ø‡§æ‡•§", "bot");
        appendInlineSuggestions(["‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§™‡•Ç‡§õ‡•á‡§Ç", "‡§∏‡§π‡§æ‡§Ø‡§§‡§æ"]);
        return;
    }

    const { intent, member_name, detail_type, answer, confidence } = analysisResult;
    let followupSuggestions = [];

    if (confidence === 'low' && !['general_query', 'greet', 'thank_you'].includes(intent)) {
        appendMessage("‡§Æ‡•à‡§Ç ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Ç‡§Å ‡§ï‡§ø ‡§Ü‡§™ ‡§ï‡•ç‡§Ø‡§æ ‡§™‡•Ç‡§õ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§•‡•ã‡§°‡§º‡§æ ‡§î‡§∞ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç?", "bot");
        appendInlineSuggestions(["‡§π‡§æ‡§Å", "‡§®‡§π‡•Ä‡§Ç", "‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç ‡§¶‡§ø‡§ñ‡§æ‡§ì"]);
        return;
    }

    try {
        if (member_name === "self" && intent === "get_member_specific_data") {
            appendMessage("‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§§‡§æ‡§è‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§ñ ‡§∏‡§ï‡•Ç‡§Ç‡•§ (‡§â‡§¶‡§æ: '‡§Ö‡§Æ‡§ø‡§§ ‡§ï‡•Å‡§Æ‡§æ‡§∞ ‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏')", "bot");
            followupSuggestions = memberNamesList.length > 0 ? memberNamesList.slice(0, 3).map(n => `${n} ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£?`) : ["‡§∏‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì"];
            appendInlineSuggestions(followupSuggestions);
            return;
        }

        switch (intent) {
            case "greet":
                appendMessage("‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•à‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å?", "bot");
                appendInlineSuggestions(["‡§®‡§ø‡§Ø‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à‡§Ç?", "‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§ì", "‡§Æ‡•á‡§∞‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ï‡§ø‡§§‡§®‡§æ ‡§π‡•à?"]);
                break;

            case "thank_you":
                appendMessage("‡§ï‡•ã‡§à ‡§¨‡§æ‡§§ ‡§®‡§π‡•Ä‡§Ç! ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡§∞‡§ï‡•á ‡§ñ‡•Å‡§∂‡•Ä ‡§π‡•Å‡§à!", "bot");
                appendInlineSuggestions(["‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç", "‡§∏‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Æ", "‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡•Ç‡§ö‡•Ä"]);
                break;

            case "get_rule":
                if (answer) {
                    const msgEl = appendMessage("", "bot");
                    typeEffect(answer, msgEl, () => appendInlineSuggestions(["‡§ï‡•ã‡§à ‡§î‡§∞ ‡§®‡§ø‡§Ø‡§Æ?", "‡§≤‡•ã‡§® ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ?", "‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§¶‡§ø‡§ñ‡§æ‡§ì"]));
                } else {
                    appendMessage("‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Æ‡•Å‡§ù‡•á ‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ï‡•ã‡§à ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§®‡§ø‡§Ø‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§", "bot");
                    appendInlineSuggestions(["‡§∏‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì", "‡§≤‡•ã‡§® ‡§ï‡•à‡§∏‡•á ‡§Æ‡§ø‡§≤‡§§‡§æ ‡§π‡•à?"]);
                }
                break;

            case "get_member_specific_data":
                if (!member_name) {
                    appendMessage("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§§‡§æ‡§è‡§Ç‡•§ (‡§â‡§¶‡§æ‡§π‡§∞‡§£: '‡§Ö‡§Æ‡§ø‡§§ ‡§ï‡•Å‡§Æ‡§æ‡§∞ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£')", "bot");
                    followupSuggestions = memberNamesList.length > 0 ? memberNamesList.slice(0, 3).map(n => `${n} ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£?`) : ["‡§∏‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì"];
                    appendInlineSuggestions(followupSuggestions);
                } else {
                    const userData = getUserDataAggregated(member_name);
                    if (!userData) {
                        appendMessage(`‡§Æ‡§æ‡§´‡§º ‡§ï‡•Ä‡§ú‡§ø‡§è, "${member_name}" ‡§®‡§æ‡§Æ ‡§ï‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§`, "bot");
                        followupSuggestions = memberNamesList.length > 0 ? memberNamesList.slice(0, 3).map(n => `${n} ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£?`) : ["‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§¶‡§ø‡§ñ‡§æ‡§ì"];
                        appendInlineSuggestions(followupSuggestions);
                    } else {
                        let responseText = "";
                        let isHtml = false;
                        switch (detail_type) {
                            case "balance":
                                responseText = `${userData.name} ‡§ï‡§æ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‚Çπ${userData.overallBalance.toLocaleString('en-IN')} ‡§π‡•à‡•§`;
                                followupSuggestions = [`${userData.name} ‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£?`, `${userData.name} ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡§æ ‡§π‡•à?`];
                                break;
                            case "loan_eligibility":
                                const eligibility = calculateEligibility(userData.name, userData.overallBalance);
                                responseText = eligibility.isEligible
                                    ? `‚úÖ ‡§π‡§æ‡§Å, ${userData.name} ‡§≤‡•ã‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§§‡•ç‡§∞ ‡§π‡•à‡§Ç‡•§ ‡§µ‡•á ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‚Çπ${eligibility.approvedAmount.toLocaleString('en-IN')} ‡§§‡§ï ‡§ï‡§æ ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§`
                                    : `‚ùå ‡§®‡§π‡•Ä‡§Ç, ${userData.name} ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§≤‡•ã‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§§‡•ç‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§ ${eligibility.reason || ''}`;
                                followupSuggestions = [`${userData.name} ‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏?`, "‡§≤‡•ã‡§® ‡§®‡§ø‡§Ø‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à‡§Ç?"];
                                break;
                            case "sip_status":
                                responseText = `${userData.name} ‡§ï‡•Ä ‡§á‡§∏ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä SIP ‡§∏‡•ç‡§•‡§ø‡§§‡§ø: <span class="sip-status ${userData.sipStatusClass}">${userData.sipStatusText}</span>`;
                                isHtml = true;
                                followupSuggestions = [`${userData.name} ‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏?`, "SIP ‡§®‡§ø‡§Ø‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à‡§Ç?"];
                                break;
                            case "outstanding_loan":
                                responseText = `${userData.name} ‡§ï‡•Ä ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡•ã‡§® ‡§∞‡§æ‡§∂‡§ø ‚Çπ${userData.netLoanOutstanding.toLocaleString('en-IN')} ‡§π‡•à‡•§`;
                                followupSuggestions = [`${userData.name} ‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏?`, `${userData.name} ‡§ï‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®?`];
                                break;
                            case "full_details":
                            default:
                                const primeTag = userData.isPrimeMember ? `<span class='prime-tag-on-photo'>‚≠ê Prime</span>` : '';
                                const unclearedLoan = userData.hasUnclearedLoan ? `<p><span class="label"><i class="fas fa-exclamation-triangle icon"></i> ‡§π‡§æ‡§≤‡§ø‡§Ø‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡•ã‡§®:</span> <span class='value loan-highlight'>‚Çπ${userData.latestUnclearedLoanAmount.toLocaleString('en-IN')}</span></p>` : '';
                                responseText = `
                                    <div class='user-details-card'>
                                        <div class="user-details-header"> <div class="profile-pic-container"> <img src="${userData.imageUrl}" alt="${userData.name}" class="profile-pic" onclick="openImageModal('${userData.imageUrl}')"> ${primeTag} </div> <div class="user-info"> <h3>${userData.name}</h3> <p><span class="label"><i class="fas fa-calendar-alt icon"></i> ‡§ú‡•ç‡§µ‡§æ‡§á‡§® ‡§§‡§ø‡§•‡§ø:</span> ${userData.joinDate}</p> </div> </div>
                                        <div class="user-stats">
                                            <p><span class="label"><i class="fas fa-piggy-bank icon"></i> ‡§ï‡•Å‡§≤ SIP ‡§ú‡§Æ‡§æ:</span> <span class="value">‚Çπ${userData.totalSIP.toLocaleString('en-IN')}</span></p>
                                            <p><span class="label"><i class="fas fa-hand-holding-usd icon"></i> ‡§ï‡•Å‡§≤ ‡§≤‡•ã‡§® ‡§≤‡§ø‡§Ø‡§æ:</span> <span class="value">‚Çπ${userData.totalLoan.toLocaleString('en-IN')}</span></p>
                                            <p><span class="label"><i class="fas fa-receipt icon"></i> ‡§ï‡•Å‡§≤ ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®:</span> <span class="value">‚Çπ${userData.totalPayment.toLocaleString('en-IN')}</span></p>
                                            <p><span class="label"><i class="fas fa-wallet icon"></i> ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏:</span> <strong class="value">‚Çπ${userData.overallBalance.toLocaleString('en-IN')}</strong></p>
                                            <p><span class="label"><i class="fas fa-chart-line icon"></i> ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§≤‡•ã‡§® ‡§∞‡§æ‡§∂‡§ø:</span> <span class="value ${userData.netLoanOutstanding > 0 ? 'loan-highlight' : ''}">‚Çπ${userData.netLoanOutstanding.toLocaleString('en-IN')}</span></p>
                                            ${unclearedLoan}
                                            <p><span class="label"><i class="fas fa-bell icon"></i> ‡§Æ‡§æ‡§∏‡§ø‡§ï SIP ‡§∏‡•ç‡§•‡§ø‡§§‡§ø:</span> <span class="value"><span class="sip-status ${userData.sipStatusClass}">${userData.sipStatusText}</span></span></p>
                                        </div>
                                    </div>`;
                                isHtml = true;
                                followupSuggestions = [`${userData.name} ‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏?`, `${userData.name} ‡§≤‡•ã‡§® ‡§≤‡•á ‡§∏‡§ï‡§§‡§æ ‡§π‡•à?`];
                                break;
                        }
                        if (isHtml) {
                            appendMessage(responseText, "bot", true);
                            appendInlineSuggestions(followupSuggestions);
                        } else {
                            const msgEl = appendMessage("", "bot");
                            typeEffect(responseText, msgEl, () => appendInlineSuggestions(followupSuggestions));
                        }
                    }
                }
                break;
            
            case "list_all_members":
                const names = memberNamesList.sort((a, b) => a.localeCompare(b));
                if (names.length > 0) {
                    let html = `<p><strong>‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø (${names.length}):</strong></p><div class='member-list-container'>`;
                    names.forEach(name => {
                        html += `<div class='clickable-member' onclick="triggerSend('${name.replace(/'/g, "\\'")}')">${name}</div>`;
                    });
                    html += "</div>";
                    appendMessage(html, 'bot', true);
                    followupSuggestions = names.slice(0, 2).map(n => `${n} ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£?`).concat(["‡§ï‡•Å‡§≤ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡§ø‡§§‡§®‡•á ‡§π‡•à‡§Ç?"]);
                    appendInlineSuggestions(followupSuggestions);
                } else {
                    appendMessage("‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "bot");
                }
                break;

            case "get_member_count":
                appendMessage(`‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§≤ ${memberNamesList.length} ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§π‡•à‡§Ç‡•§`, "bot");
                appendInlineSuggestions(["‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§ì", "‡§∏‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì"]);
                break;

            case "general_query":
            default:
                if (answer) {
                    const msgEl = appendMessage("", "bot");
                    typeEffect(answer, msgEl, () => appendInlineSuggestions(["‡§î‡§∞ ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡•á‡§Ç?", "‡§∏‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì"]));
                } else {
                    appendMessage("‡§Æ‡•à‡§Ç ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§∏‡•Ä‡§ñ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¶‡•Ç‡§∏‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç?", "bot");
                    appendInlineSuggestions(["‡§∏‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì", "‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§∏‡•Ç‡§ö‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§ì"]);
                }
                break;
        }
    } catch (error) {
        console.error("‡§á‡§∞‡§æ‡§¶‡•á ‡§ï‡•ã ‡§∏‡§Ç‡§≠‡§æ‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", intent, error);
        appendMessage("‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Ü‡§™‡§ï‡•á ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡•ã ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§ø‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§", "bot");
    } finally {
        scrollToBottom();
    }
}

// --- 5. EVENT LISTENERS & INITIALIZATION ---
function handleKey(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        send();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§ ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à...");
    fetchFirebaseData().then(() => {
        console.log("‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü‡•§");
    });
});

imageModal.addEventListener('click', (event) => {
    if (event.target === imageModal) closeImageModal();
});
</script>
</body>
</html>

