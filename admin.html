<!DOCTYPE html>
<html>
<head>
  <title>RMZ Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
  :root {
    --primary: #4361ee;
    --secondary: #3f37c9;
    --success: #4cc9f0;
    --danger: #f72585;
    --warning: #f8961e;
    --info: #4895ef;
    --light: #f8f9fa;
    --dark: #212529;
    --gray: #6c757d;
    --red: #e63946;
    --black: #1a1a1a;
    --yellow: #ffd166;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background: #f5f7fa;
    color: #333;
    line-height: 1.5;
    /* Removed fixed height and centering to allow scrolling */
    min-height: 100vh;
    padding: 20px 0; /* Add some padding */
  }

  /* Password Protection Styles */
  .login-container {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 400px;
    text-align: center;
    /* Center login screen specifically */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  /* Ensure dashboard is not absolutely positioned */
  #dashboard {
      display: none; /* Initially hidden */
      position: relative;
      top: auto;
      left: auto;
      transform: none;
      margin: 0 auto; /* Center dashboard content */
  }


  .login-container h2 {
    color: var(--primary);
    margin-bottom: 20px;
  }

  .login-input {
    width: 100%;
    padding: 12px 15px;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
  }

  .login-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    width: 100%;
    margin-top: 10px;
    transition: background 0.3s;
  }

  .login-btn:hover {
    background: var(--secondary);
  }

  .error-message {
    color: var(--danger);
    margin-top: 10px;
    display: none;
  }

  /* Dashboard Styles */
  .container {
    /* display: none; */ /* Controlled by JS now */
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px;
    width: 100%;
  }

  .header {
    text-align: center;
    margin-bottom: 20px; /* Increased margin for better visibility */
    padding: 10px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }

  .header h1 {
    color: var(--primary);
    font-weight: 600;
    font-size: 1.8rem; /* Increased font size */
  }

  /* Compact Cards */
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }

  .card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: transform 0.3s ease;
    text-align: center; /* Center the content */
    cursor: pointer; /* Indicate it's clickable */
  }

  .card:hover {
    transform: translateY(-3px);
  }

  .card h3 {
    color: var(--gray);
    font-size: 0.85rem;
    margin-bottom: 5px;
  }

  .card .value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary);
  }

  .notification-card {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .notification-card i {
    font-size: 2rem;
    color: var(--warning);
    margin-bottom: 10px;
  }

  .notification-card span {
    font-size: 1rem;
    color: var(--dark);
    font-weight: 500;
  }

  /* Shares Info Cards */
  .shares-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
  }

  .shares-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    text-align: center;
  }

  .shares-card h3 {
    color: var(--gray);
    font-size: 0.9rem;
    margin-bottom: 5px;
  }

  .shares-card .value {
    font-size: 1.5rem;
    font-weight: 600;
  }

  .total-shares {
    color: var(--black);
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  }

  .available-shares {
    color: var(--red);
    background: linear-gradient(135deg, #ffefba 0%, #ffffff 100%);
  }

  .add-member-card {
    background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .add-member-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }

  .add-member-card i {
    font-size: 2rem;
    color: var(--primary);
    margin-bottom: 10px;
  }

  .add-member-card h3 {
    color: var(--dark);
    font-size: 1rem;
    margin-bottom: 5px;
  }

  /* Notification Update Section */
  .notification-update-section {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
  }

  .notification-update-section h2 {
    color: var(--primary);
    font-size: 1.2rem;
    margin-bottom: 15px;
  }

  .notification-form label {
    display: block;
    margin-bottom: 5px;
    font-size: 0.9rem;
    color: var(--dark);
  }

  .notification-form input[type="text"],
  .notification-form input[type="file"], /* Added file type */
  .notification-form textarea {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
    box-sizing: border-box;
  }

  .notification-form textarea {
    resize: vertical;
    min-height: 80px;
  }

  .notification-form button {
    background: var(--success);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.3s ease;
  }

  .notification-form button:hover {
    background: var(--info);
  }

   .image-preview-small { /* Style for notification image preview */
      max-width: 100px;
      max-height: 100px;
      margin-top: 5px;
      display: none; /* Initially hidden */
      border: 1px solid #ddd;
      padding: 2px;
   }

   .upload-status { /* Style for upload status messages */
        font-size: 0.8rem;
        margin-top: -5px;
        margin-bottom: 10px;
        color: var(--gray);
   }


  .search-card {
    display: flex;
    flex-direction: column;
  }

  .search-input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  .btn {
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--secondary);
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  /* Users Section */
  .users-section {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .section-header h2 {
    color: var(--primary);
    font-size: 1.2rem;
  }

  .toggle-users {
    background: var(--light);
    color: var(--primary);
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8rem;
  }

  /* Compact User List */
  .user-list {
    display: none;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 8px;
    list-style: none;
  }

  .user-list.show {
    display: grid;
  }

  .user-item {
    background: var(--light);
    padding: 8px;
    border-radius: 5px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.85rem;
  }

  .user-item:hover {
    background: var(--primary);
    color: white;
  }

  /* Search and Filter Row */
  .search-filter-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  .search-filter-row input,
  .search-filter-row select {
    flex: 1;
    min-width: 150px;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
  }

  /* Add Member Button */
  .add-member-btn {
    background: var(--success);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-left: auto;
  }

  /* Profile Picture Preview */
  .profile-pic-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 15px;
  }

  .profile-pic-preview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--primary);
    margin-bottom: 10px;
    background-color: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* Ensures image stays within bounds */
  }

 .profile-pic-preview img { /* Style for the image inside preview */
    width: 100%;
    height: 100%;
    object-fit: cover;
 }


  .profile-pic-preview i {
    font-size: 2rem;
    color: var(--gray);
  }

   /* Style for file input - visually hidden but accessible */
   .file-input-label {
       display: inline-block;
       padding: 6px 12px;
       cursor: pointer;
       background-color: var(--light);
       color: var(--primary);
       border: 1px solid var(--primary);
       border-radius: 5px;
       font-size: 0.85rem;
       transition: background-color 0.3s;
   }
   .file-input-label:hover {
       background-color: #e2e6ea;
   }
   .file-input {
       display: none; /* Hide the default file input */
   }


  /* User Details Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    overflow-y: auto; /* Allow modal scroll */
    padding: 20px 0; /* Add padding for scroll */
  }

  .modal-content {
    background: white;
    margin: 30px auto;
    max-width: 600px;
    width: 95%;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }

  .modal-header h2 {
    color: var(--primary);
    font-size: 1.3rem;
  }

  .close-modal {
    background: none;
    border: none;
    font-size: 1.3rem;
    cursor: pointer;
    color: var(--gray);
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    font-size: 0.9rem;
  }

  .form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
  }

  .btn-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .btn-danger {
    background: var(--danger);
    color: white;
  }

  .btn-secondary {
    background: var(--gray);
    color: white;
  }

  .history-list {
    margin-top: 15px;
    max-height: 150px;
    overflow-y: auto;
    padding: 8px;
    background: var(--light);
    border-radius: 5px;
    font-size: 0.85rem;
  }

  .history-item {
    padding: 8px;
    border-bottom: 1px solid #ddd;
  }

  .history-item:last-child {
    border-bottom: none;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .dashboard-grid {
      grid-template-columns: 1fr 1fr;
    }

    .shares-container {
      grid-template-columns: 1fr;
    }

    .search-filter-row {
      flex-direction: column;
      gap: 8px;
    }

    .add-member-btn {
      margin-left: 0;
      width: 100%;
      justify-content: center;
    }

    .btn-group {
      flex-direction: column;
    }

    .btn-group button {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .dashboard-grid {
      grid-template-columns: 1fr;
    }

    .user-list {
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    }
     .login-container {
       width: 95%;
     }
  }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<div id="loginScreen" class="login-container">
  <h2>Admin Panel Access</h2>
  <p>Please enter the 6-digit password to continue</p>
  <input type="password" id="passwordInput" class="login-input" placeholder="Enter password" maxlength="6" inputmode="numeric">
  <button class="login-btn" onclick="checkPassword()">Submit</button>
  <p id="errorMsg" class="error-message">Incorrect password. Please try again.</p>
</div>

<div class="container" id="dashboard">
  <header class="header">
    <h1>RMZ Admin Dashboard</h1>
    <p>Manage members, shares, and transactions</p>
  </header>

  <div class="shares-container">
    <div class="shares-card total-shares">
      <h3>Total Shares</h3>
      <div class="value" id="totalSharesValue">1000</div>
    </div>

    <div class="shares-card available-shares">
      <h3>Available Shares</h3>
      <div class="value" id="availableSharesValue">1000</div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="card">
      <h3>Total Members</h3>
      <div class="value" id="totalUsers">0</div>
    </div>

    <div class="card">
      <h3>Shares Sold</h3>
      <div class="value" id="totalShares">0</div>
    </div>

    <div class="add-member-card" onclick="showAddMemberForm()">
      <i class="fas fa-user-plus"></i>
      <h3>Add New Member</h3>
    </div>

    <div class="card notification-card" onclick="toggleNotificationSection()">
      <i class="fas fa-bell"></i>
      <span>Manage Notifications</span>
    </div>
  </div>

  <section id="notificationSection" class="notification-update-section" style="display: none;">
    <h2>Update Notifications</h2>
    <div class="notification-form">
      <label for="notificationHeadline">Headline:</label>
      <input type="text" id="notificationHeadline" placeholder="Enter headline">

      <label for="notificationSummary">Summary Text:</label>
      <textarea id="notificationSummary" placeholder="Enter summary text"></textarea>

      <label for="notificationLink">Link (Optional):</label>
      <input type="text" id="notificationLink" placeholder="Enter link URL">

      <label for="notificationImageFile">Image (Optional):</label>
      <input type="file" id="notificationImageFile" class="file-input" accept="image/*">
      <label for="notificationImageFile" class="file-input-label">Choose Image</label>
      <img id="notificationImagePreview" class="image-preview-small" src="#" alt="Image Preview"/>
      <div id="notificationImageStatus" class="upload-status"></div>
      <input type="hidden" id="notificationImageLink"> <button onclick="saveNotification()" id="saveNotificationBtn">Update Notification</button>
      <p id="notificationStatus" style="margin-top: 10px; display: none;"></p>

      <h3>Previous Notifications</h3>
      <ul id="previousNotifications"></ul>
    </div>
  </section>

  <div class="search-filter-row">
    <input type="text" id="searchBox" class="search-input" placeholder="Search by ID, name or mobile">
    <select id="filterShares" class="search-input">
      <option value="">All Shares</option>
      <option value="0-10">0-10 Shares</option>
      <option value="11-30">11-30 Shares</option>
      <option value="31-50">31-50 Shares</option>
      <option value="51-100">51-100 Shares</option>
      <option value="101+">101+ Shares</option>
    </select>
    <button class="btn btn-primary" onclick="searchAndFilter()">Apply</button>
  </div>

  <section class="users-section">
    <div class="section-header">
      <h2>All Members</h2>
      <button class="toggle-users" onclick="toggleUserList()">Show/Hide</button>
    </div>

    <ul class="user-list" id="userList"></ul>
  </section>
</div>

<div class="modal" id="userModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Member Details</h2>
      <button class="close-modal" onclick="closeModal()">&times;</button>
    </div>

    <div class="profile-pic-container">
      <div class="profile-pic-preview" id="profilePicPreview">
        <i class="fas fa-user"></i> </div>
      <input type="file" id="editProfilePicFile" class="file-input" accept="image/*">
      <label for="editProfilePicFile" class="file-input-label">Change Picture</label>
       <div id="editProfilePicStatus" class="upload-status"></div>
      <input type="hidden" id="editProfilePicUrl"> </div>

    <div class="form-group">
      <label>Name</label>
      <input type="text" id="editName" class="form-control">
    </div>

    <div class="form-group">
      <label>Email</label>
      <input type="email" id="editEmail" class="form-control">
    </div>

    <div class="form-group">
      <label>Mobile</label>
      <input type="text" id="editMobile" class="form-control">
    </div>

    <div class="form-group">
      <label>Shares</label>
      <input type="number" id="editShares" class="form-control">
    </div>

    <div class="form-group">
      <label>RMZ ID</label>
      <p id="rmzIdDisplay">-</p>
    </div>


    <div class="form-group">
      <label>Created At</label>
      <p id="createdAt">-</p>
    </div>

    <div class="form-group">
      <label>Last Login</label>
      <p id="lastLogin">-</p>
    </div>

    <div class="form-group">
      <label>Transaction History</label>
      <div class="history-list" id="historyList"></div>
    </div>

    <div class="btn-group">
      <button class="btn btn-success" onclick="saveUser()" id="saveUserBtn">Save Changes</button>
      <button class="btn btn-secondary" onclick="closeModal()">Close</button>
      <button class="btn btn-danger" onclick="deleteUser()">Delete Member</button>
    </div>
  </div>
</div>

<div class="modal" id="addMemberModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New Member</h2>
      <button class="close-modal" onclick="closeAddModal()">&times;</button>
    </div>

    <div class="profile-pic-container">
      <div class="profile-pic-preview" id="newProfilePicPreview">
         <i class="fas fa-user"></i> </div>
       <input type="file" id="newUserProfilePicFile" class="file-input" accept="image/*">
       <label for="newUserProfilePicFile" class="file-input-label">Upload Picture</label>
       <div id="newUserProfilePicStatus" class="upload-status"></div>
       <input type="hidden" id="newUserProfilePicUrl"> </div>


    <div class="form-group">
      <label>Name</label>
      <input type="text" id="newUserName" class="form-control" placeholder="Enter full name" required>
    </div>

    <div class="form-group">
      <label>Mobile Number</label>
      <input type="tel" id="newUserMobile" class="form-control" placeholder="Enter mobile number" required>
    </div>

    <div class="form-group">
      <label>Email (Optional)</label> <input type="email" id="newUserEmail" class="form-control" placeholder="Enter email address">
    </div>

    <div class="form-group">
      <label>Initial Shares</label>
      <input type="number" id="newUserShares" class="form-control" value="0" min="0" required>
    </div>

    <div class="btn-group">
      <button class="btn btn-success" onclick="addNewMember()" id="addMemberBtn">Add Member</button>
      <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
  // Firebase configuration (Keep yours)
  const firebaseConfig = {
    apiKey: "AIzaSyCV_IDpmD35weDRi4GDegnT2m2RV_qHclc", // Replace with your actual API key
    authDomain: "re-sh-51ff6.firebaseapp.com",
    databaseURL: "https://re-sh-51ff6-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "re-sh-51ff6",
    storageBucket: "re-sh-51ff6.appspot.com", // This is no longer used by the script but fine to keep
    messagingSenderId: "870340778217",
    appId: "1:870340778217:web:7dd6792c2bb80cdee6b878",
    measurementId: "G-E3884F19J2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  // const storage = firebase.storage(); // Firebase Storage is no longer used

  let currentUserId = ''; // Stores the Firebase key of the user being edited
  let originalProfilePicUrl = ''; // Store original URL when editing
  let originalNotificationImageUrl = ''; // Store original URL when editing notification
  const TOTAL_SHARES_CAP = 1000; // कुल शेयर्स की सीमा
  const MAX_NOTIFICATIONS_DISPLAY = 5; // पिछली सूचनाओं की संख्या

  // --- ImgBB Configuration ---
  const imgbbApiKey = '65bbcf742486328061382f03949b47c6'; // <-- IMPORTANT: Replace with your actual ImgBB API key
  const imgbbUploadUrl = 'https://api.imgbb.com/1/upload';

  // Password Protection
  const ADMIN_PASSWORD = "753690"; // अपना सुरक्षित पासवर्ड यहाँ सेट करें

  function checkPassword() {
    const enteredPassword = document.getElementById('passwordInput').value;
    const errorMsg = document.getElementById('errorMsg');

    if (enteredPassword === ADMIN_PASSWORD) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block'; // Show dashboard
      loadDashboard();
      loadNotifications(); // मौजूदा सूचनाएं लोड करें
    } else {
      errorMsg.style.display = 'block';
      document.getElementById('passwordInput').value = '';
      setTimeout(() => {
        errorMsg.style.display = 'none';
      }, 3000);
    }
  }

  // Enter दबाने पर पासवर्ड सबमिट करने की अनुमति दें
  document.getElementById('passwordInput').addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
      checkPassword();
    }
  });

  // --- ImgBB Image Upload Function ---
  async function uploadImageToImgBB(fileInputId, statusElementId) {
      const fileInput = document.getElementById(fileInputId);
      const statusElement = document.getElementById(statusElementId);

      if (!imgbbApiKey || imgbbApiKey === 'YOUR_IMGBB_API_KEY') {
           console.error("ImgBB API Key is not configured.");
           if (statusElement) statusElement.textContent = 'Upload Error: API Key missing.';
           return null;
      }

      if (!fileInput.files || fileInput.files.length === 0) {
          if (statusElement) statusElement.textContent = ''; // Clear previous status
          return null; // No file selected
      }

      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('image', file);
      // Optional: Set expiration if needed (e.g., '600' for 10 minutes)
      // formData.append('expiration', '600');

      if (statusElement) statusElement.textContent = 'Uploading...';

      try {
          const response = await fetch(`${imgbbUploadUrl}?key=${imgbbApiKey}`, {
              method: 'POST',
              body: formData,
          });

          const result = await response.json();

          if (response.ok && result.success) {
              if (statusElement) statusElement.textContent = 'Upload successful!';
              setTimeout(() => { if (statusElement) statusElement.textContent = ''; }, 2000);
              console.log("ImgBB Upload Result:", result);
              return result.data.url; // Return the direct image URL
          } else {
              console.error("ImgBB Upload Error:", result);
              const errorMessage = result?.error?.message || `HTTP error! status: ${response.status}`;
              if (statusElement) statusElement.textContent = `Upload failed: ${errorMessage}`;
              return null;
          }
      } catch (error) {
          console.error("ImgBB Fetch Error:", error);
          if (statusElement) statusElement.textContent = 'Upload failed. Check console.';
          return null; // Indicate failure
      }
  }


  // --- Image Preview Functions ---
 function displayImagePreview(fileInputId, previewElementId) {
      const fileInput = document.getElementById(fileInputId);
      const previewElement = document.getElementById(previewElementId);

      if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();

          reader.onload = function(e) {
              // मुख्य प्रोफाइल पिक प्रीव्यू के लिए, सामग्री बदलें
              if (previewElementId === 'profilePicPreview' || previewElementId === 'newProfilePicPreview') {
                 previewElement.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
              }
              // छोटे नोटिफिकेशन प्रीव्यू के लिए, src सेट करें और दिखाएं
              else if (previewElementId === 'notificationImagePreview') {
                  previewElement.src = e.target.result;
                  previewElement.style.display = 'block';
              }
          }
          reader.readAsDataURL(fileInput.files[0]);
      } else {
          // यदि कोई फ़ाइल नहीं चुनी गई है तो वैकल्पिक रूप से प्रीव्यू छिपाएं (नोटिफिकेशन के लिए)
           if (previewElementId === 'notificationImagePreview') {
                previewElement.src = '#';
                previewElement.style.display = 'none';
            }
            // प्रोफाइल पिक के लिए डिफ़ॉल्ट आइकन पर रीसेट करें
           else if (previewElementId === 'profilePicPreview' || previewElementId === 'newProfilePicPreview'){
                 previewElement.innerHTML = '<i class="fas fa-user"></i>';
           }
      }
  }

 function setPreviewFromUrl(url, previewElementId) {
    const previewElement = document.getElementById(previewElementId);
     if (previewElementId === 'profilePicPreview' || previewElementId === 'newProfilePicPreview') {
        if (url) {
            previewElement.innerHTML = `<img src="${url}" alt="Profile Picture">`;
        } else {
            previewElement.innerHTML = '<i class="fas fa-user"></i>'; // डिफ़ॉल्ट आइकन
        }
     }
     else if (previewElementId === 'notificationImagePreview') {
         if(url) {
             previewElement.src = url;
             previewElement.style.display = 'block';
         } else {
             previewElement.src = '#';
             previewElement.style.display = 'none';
         }
     }
  }

  // Event listeners for image previews when file is selected
  document.getElementById('newUserProfilePicFile').addEventListener('change', () => displayImagePreview('newUserProfilePicFile', 'newProfilePicPreview'));
  document.getElementById('editProfilePicFile').addEventListener('change', () => displayImagePreview('editProfilePicFile', 'profilePicPreview'));
  document.getElementById('notificationImageFile').addEventListener('change', () => displayImagePreview('notificationImageFile', 'notificationImagePreview'));


  function formatDateTime(isoString) {
    if (!isoString) return "N/A";
    try {
        const dateObj = new Date(isoString);
        // जांचें कि क्या तारीख मान्य है
        if (isNaN(dateObj.getTime())) {
            return "Invalid Date";
        }
        return dateObj.toLocaleString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    } catch (e) {
        console.error("Error formatting date:", isoString, e);
        return "Date Error";
    }
}


  function loadDashboard() {
    db.ref('users').orderByKey().once('value', snapshot => { // Order by Firebase key
      const data = snapshot.val();
      let totalUsersCount = 0;
      let totalSharesSold = 0;
      let html = '';

      if (data) {
         // Firebase द्वारा कुंजी के अनुसार क्रमबद्ध डेटा पहले से ही है
         Object.keys(data).forEach(id => {
            if (data[id]) { // सुनिश्चित करें कि उपयोगकर्ता डेटा मौजूद है
                 totalUsersCount++;
                 totalSharesSold += parseInt(data[id].shares || 0);
                 const displayId = data[id].rmzID || id; // प्रदर्शन के लिए RMZ ID का उपयोग करें
                 html += `<li class="user-item" onclick="loadUserData('${id}')">${displayId}</li>`;
            }
        });
      }

      if (html === '') {
        html = '<li>No members found</li>';
      }

      document.getElementById('totalUsers').innerText = totalUsersCount;
      document.getElementById('totalShares').innerText = totalSharesSold;
      document.getElementById('availableSharesValue').innerText = Math.max(0, TOTAL_SHARES_CAP - totalSharesSold);
      document.getElementById('userList').innerHTML = html;
    }, error => {
        console.error("Error loading users:", error);
        alert("Could not load user data. Please check console.");
        document.getElementById('userList').innerHTML = '<li>Error loading members</li>';
    });
  }

  function toggleUserList() {
    const userList = document.getElementById('userList');
    userList.classList.toggle('show');
  }

  function searchAndFilter() {
    const searchTerm = document.getElementById('searchBox').value.trim().toLowerCase();
    const shareFilter = document.getElementById('filterShares').value;

    db.ref('users').orderByKey().once('value', snapshot => { // Order by Firebase key
      const data = snapshot.val();
      let html = '';
      let filteredCount = 0;
      let filteredSharesSold = 0;
      let allUsersTotalShares = 0; // सभी उपयोगकर्ताओं के कुल शेयर गणना करने के लिए

      if (data) {
        Object.keys(data).forEach(id => {
          const user = data[id];
          if (!user) return;

          // सभी उपयोगकर्ताओं के कुल शेयरों की गणना करें
          allUsersTotalShares += parseInt(user.shares || 0);

          const userName = user.name ? user.name.toLowerCase() : '';
          const userMobile = user.mobile ? user.mobile.toLowerCase() : '';
          const userRmzId = user.rmzID ? user.rmzID.toLowerCase() : id.toLowerCase(); // RMZ ID या कुंजी द्वारा खोजें
          const userShares = parseInt(user.shares || 0);

          // खोज शब्द जांचें (ID, नाम, मोबाइल)
          const matchesSearch = searchTerm === '' ||
                               userRmzId.includes(searchTerm) ||
                               userName.includes(searchTerm) ||
                               userMobile.includes(searchTerm);

          // शेयर फ़िल्टर जांचें
          let matchesFilter = true;
          if (shareFilter !== '') {
            const range = shareFilter.split('-');
            if (range.length === 2) {
                const min = parseInt(range[0]);
                const max = parseInt(range[1]);
                 // शामिल करने के लिए सीमा जांच को समायोजित करें
                if (!isNaN(min) && !isNaN(max)) {
                    matchesFilter = userShares >= min && userShares <= max;
                } else {
                    matchesFilter = false; // अमान्य सीमा
                }
            } else if (shareFilter === '101+') { // 101+ केस हैंडल करें
                 matchesFilter = userShares >= 101;
            } else {
                matchesFilter = false; // अमान्य फ़िल्टर मान
            }
          }


          if (matchesSearch && matchesFilter) {
            filteredCount++;
            filteredSharesSold += userShares;
            const displayId = user.rmzID || id;
            html += `<li class="user-item" onclick="loadUserData('${id}')">${displayId}</li>`;
          }
        });
      }

      if (html === '') {
        html = '<li>No matching members found</li>';
      }

      document.getElementById('userList').innerHTML = html;

      // डैशबोर्ड कार्ड अपडेट करें
       document.getElementById('totalUsers').innerText = filteredCount; // फ़िल्टर किए गए सदस्यों की संख्या दिखाएं
       document.getElementById('totalShares').innerText = filteredSharesSold; // केवल फ़िल्टर किए गए सदस्यों के शेयर दिखाएं
       // उपलब्ध शेयर हमेशा कुल कैप और *सभी* बेचे गए शेयरों पर आधारित होते हैं
       document.getElementById('availableSharesValue').innerText = Math.max(0, TOTAL_SHARES_CAP - allUsersTotalShares);

       // यदि खोज/फ़िल्टर साफ़ है, तो पूर्ण डैशबोर्ड आँकड़े पुनः लोड करें
       if(searchTerm === '' && shareFilter === '') {
            loadDashboard(); // यह ओवरराइड करेगा और सभी सदस्यों के आँकड़े दिखाएगा
       }


      // फ़िल्टरिंग/खोज के बाद सूची हमेशा दिखाएं
      document.getElementById('userList').classList.add('show');
    }, error => {
         console.error("Error searching/filtering users:", error);
         alert("Could not perform search/filter. Please check console.");
         document.getElementById('userList').innerHTML = '<li>Error during search</li>';
    });
  }


  function loadUserData(id) {
    db.ref('users/' + id).once('value', snap => {
      if (!snap.exists()) {
        alert("Member data not found for ID: " + id);
        return;
      }

      const user = snap.val();
      currentUserId = id; // Firebase कुंजी स्टोर करें
      originalProfilePicUrl = user.profilePic || ''; // मूल पिक URL स्टोर करें

      const displayId = user.rmzID || id; // प्रदर्शन के लिए RMZ ID का उपयोग करें
      document.getElementById('modalTitle').textContent = `Member: ${displayId}`;

      // फ़ॉर्म फ़ील्ड भरें
      document.getElementById('editName').value = user.name || '';
      document.getElementById('editEmail').value = user.email || '';
      document.getElementById('editMobile').value = user.mobile || '';
      document.getElementById('editShares').value = user.shares || 0;
      document.getElementById('rmzIdDisplay').textContent = displayId; // RMZ ID प्रदर्शित करें
      document.getElementById('createdAt').textContent = formatDateTime(user.createdAt);
      document.getElementById('lastLogin').textContent = formatDateTime(user.lastLogin);

      // पिछला फ़ाइल इनपुट स्टेटस/मान साफ़ करें
      document.getElementById('editProfilePicFile').value = null;
      document.getElementById('editProfilePicStatus').textContent = '';
      document.getElementById('editProfilePicUrl').value = originalProfilePicUrl; // URL को छिपे हुए इनपुट में स्टोर करें (हालांकि सीधे उपयोग नहीं किया गया)

      // संग्रहीत URL से प्रोफ़ाइल चित्र प्रीव्यू सेट करें
      setPreviewFromUrl(originalProfilePicUrl, 'profilePicPreview');

      // इतिहास सूची बनाएं
      let historyHtml = '';
      if (user.history) {
         const sortedHistoryKeys = Object.keys(user.history).sort((a, b) => {
             // सुनिश्चित करें कि दिनांक मौजूद है, अन्यथा 0 का उपयोग करें
             const dateA = new Date(user.history[a]?.date || 0).getTime();
             const dateB = new Date(user.history[b]?.date || 0).getTime();
             return dateB - dateA; // नवीनतम पहले
         });

        sortedHistoryKeys.forEach(key => {
          const tx = user.history[key];
          // सुनिश्चित करें कि लेन-देन ऑब्जेक्ट मान्य है
           if (tx && tx.date !== undefined && tx.shares !== undefined) {
              historyHtml += `
                <div class="history-item">
                  <strong>${formatDateTime(tx.date)}</strong><br>
                  ${tx.shares > 0 ? '+' : ''}${tx.shares} shares - ${tx.note || 'No description'}
                </div>
              `;
           }
        });
      }
       if (historyHtml === '') {
           historyHtml = '<div class="history-item">No transaction history</div>';
       }
      document.getElementById('historyList').innerHTML = historyHtml;

      // मोडल दिखाएं
      document.getElementById('userModal').style.display = 'block';
    }, error => {
        console.error("Error loading user data:", error);
        alert("Could not load member details. Please check console.");
    });
  }

 async function saveUser() {
    if (!currentUserId) return;

    const saveButton = document.getElementById('saveUserBtn');
    saveButton.disabled = true; // सेव के दौरान बटन अक्षम करें
    saveButton.textContent = 'Saving...';

    let newProfilePicUrl = originalProfilePicUrl; // डिफ़ॉल्ट रूप से मूल URL रखें

    // जांचें कि क्या अपलोड के लिए नई फ़ाइल चुनी गई थी
    if (document.getElementById('editProfilePicFile').files.length > 0) {
        // ImgBB पर अपलोड करें
        const uploadedUrl = await uploadImageToImgBB('editProfilePicFile', 'editProfilePicStatus');
        if (uploadedUrl) {
             newProfilePicUrl = uploadedUrl; // यदि सफल हो तो नए URL का उपयोग करें
        } else {
             // अपलोड विफल - मूल URL रखें, उपयोगकर्ता को सूचित करें
             alert("Profile picture upload failed. Changes saved without updating picture.");
             // newProfilePicUrl पहले से ही originalProfilePicUrl पर सेट है
        }
    }

    const updatedShares = parseInt(document.getElementById('editShares').value);
    // उपलब्ध शेयरों की गणना करें (यह गणना केवल वर्तमान दृश्य पर आधारित है, बेहतर सटीकता के लिए डीबी से जांचें)
    // const availableShares = parseInt(document.getElementById('availableSharesValue').innerText || '0');
    // const currentSharesOnScreen = parseInt(document.getElementById('totalShares').innerText || '0'); // कुल बेचे गए शेयर (स्क्रीन पर)

    // Fetch current shares directly from DB for accurate comparison and validation
    db.ref('users/' + currentUserId + '/shares').once('value', async currentSharesSnap => {
        const currentDbShares = parseInt(currentSharesSnap.val() || 0);
        const shareChange = updatedShares - currentDbShares;

        // Validate against total available shares (only if increasing shares)
        if (shareChange > 0) {
            const totalSoldSharesSnapshot = await db.ref('users').once('value');
            let totalSoldShares = 0;
            if (totalSoldSharesSnapshot.exists()) {
                Object.values(totalSoldSharesSnapshot.val()).forEach(u => {
                    if (u && typeof u.shares !== 'undefined') {
                        totalSoldShares += parseInt(u.shares || 0);
                    }
                });
            }
            // Calculate shares excluding the current user's *original* count before this update
            const sharesExcludingCurrentUser = totalSoldShares - currentDbShares;
            const totalAvailableCap = TOTAL_SHARES_CAP - sharesExcludingCurrentUser; // How many shares can *this* user take max

            if (updatedShares > totalAvailableCap) {
                 alert(`Error: Cannot set shares to ${updatedShares}. Only ${totalAvailableCap} shares are available for this member considering the total cap of ${TOTAL_SHARES_CAP}.`);
                 saveButton.disabled = false;
                 saveButton.textContent = 'Save Changes';
                 return; // Stop saving
            }
        }


        const updatedData = {
          name: document.getElementById('editName').value.trim(),
          email: document.getElementById('editEmail').value.trim(),
          mobile: document.getElementById('editMobile').value.trim(),
          shares: isNaN(updatedShares) ? 0 : updatedShares, // Ensure shares is a number
          profilePic: newProfilePicUrl, // Use the determined URL (new or original)
          updatedAt: new Date().toISOString()
          // rmzID should generally not be updated here
        };

        try {
            // Add transaction history if shares changed
            if (!isNaN(updatedData.shares) && shareChange !== 0) {
                const historyEntry = {
                    date: updatedData.updatedAt, // Use update timestamp
                    shares: shareChange,
                    note: `Shares updated by admin (${shareChange > 0 ? '+' : ''}${shareChange})`
                };
                // Push new history entry
                await db.ref('users/' + currentUserId + '/history').push(historyEntry);
            }

            // Now update the main user data
            await db.ref('users/' + currentUserId).update(updatedData);

            alert("Member updated successfully!");
            loadDashboard(); // Refresh dashboard data
            closeModal();
        } catch (error) {
            console.error("Error updating member:", error);
            alert("Error updating member: " + error.message);
        } finally {
            // Re-enable button regardless of success/failure
            saveButton.disabled = false;
            saveButton.textContent = 'Save Changes';
        }

    }).catch(error => {
         console.error("Error fetching current shares:", error);
          alert("Could not fetch current shares for validation or history. Update aborted.");
          saveButton.disabled = false;
          saveButton.textContent = 'Save Changes';
    });
 }

 async function deleteUser() {
    if (!currentUserId) return;

    const userRef = db.ref('users/' + currentUserId);

    try {
        // Get RMZ ID for confirmation message
        const snap = await userRef.once('value');
        if (!snap.exists()) {
            alert("Member data not found, cannot delete.");
            return;
        }
        const userData = snap.val();
        const displayId = userData?.rmzID || currentUserId;
        // We don't need the profilePicUrl for deletion anymore

        if (!confirm(`Are you sure you want to permanently delete member ${displayId}? This action cannot be undone.`)) {
          return;
        }

        // --- Remove Firebase Storage Deletion ---
        // The profile picture hosted on ImgBB will remain, but will be orphaned.
        // No action needed here to delete the image.

        // Delete user data from Realtime Database
        await userRef.remove();

        alert(`Member ${displayId} deleted successfully from the database!`);
        loadDashboard(); // Refresh dashboard
        closeModal(); // Close modal

    } catch (error) {
        console.error("Error deleting member:", error);
        alert("Error deleting member: " + error.message + ". Please check the console for details.");
        // Don't close modal on error so user can see what went wrong
    }
 }


  function closeModal() {
    document.getElementById('userModal').style.display = 'none';
    currentUserId = ''; // Reset current ID
    originalProfilePicUrl = ''; // Reset original URL
    // Reset preview to default
    setPreviewFromUrl(null, 'profilePicPreview');
    document.getElementById('editProfilePicStatus').textContent = ''; // Clear status
    document.getElementById('editProfilePicFile').value = null; // Clear file input
  }

  function showAddMemberForm() {
      // Reset previous values
      document.getElementById('newUserName').value = '';
      document.getElementById('newUserMobile').value = '';
      document.getElementById('newUserEmail').value = '';
      document.getElementById('newUserShares').value = '0';
      document.getElementById('newUserProfilePicFile').value = null; // Clear file input
      setPreviewFromUrl(null, 'newProfilePicPreview'); // Reset preview
      document.getElementById('newUserProfilePicStatus').textContent = ''; // Clear status
      document.getElementById('newUserProfilePicUrl').value = ''; // Clear hidden URL field (not strictly needed now)
      document.getElementById('addMemberModal').style.display = 'block';
  }

  function closeAddModal() {
     document.getElementById('addMemberModal').style.display = 'none';
  }

  async function addNewMember() {
      const name = document.getElementById('newUserName').value.trim();
      const mobile = document.getElementById('newUserMobile').value.trim();
      const email = document.getElementById('newUserEmail').value.trim();
      const shares = parseInt(document.getElementById('newUserShares').value);
      const addButton = document.getElementById('addMemberBtn');

      if (!name || !mobile) {
          alert("Please enter Name and Mobile number.");
          return;
      }
      if (isNaN(shares) || shares < 0) {
          alert("Please enter a valid non-negative number for Initial Shares.");
          return;
      }

       // Check available shares
        const totalSoldSharesSnapshot = await db.ref('users').once('value');
        let totalSoldShares = 0;
        if (totalSoldSharesSnapshot.exists()) {
            Object.values(totalSoldSharesSnapshot.val()).forEach(u => {
                if (u && typeof u.shares !== 'undefined') {
                    totalSoldShares += parseInt(u.shares || 0);
                }
            });
        }
        const availableShares = TOTAL_SHARES_CAP - totalSoldShares;

        if (shares > availableShares) {
            alert(`Error: Cannot add ${shares} shares. Only ${availableShares} shares are available in total.`);
            return;
        }


      addButton.disabled = true;
      addButton.textContent = 'Adding...';

      let profilePicUrl = null;
      // Upload image if file selected
      if (document.getElementById('newUserProfilePicFile').files.length > 0) {
           profilePicUrl = await uploadImageToImgBB('newUserProfilePicFile', 'newUserProfilePicStatus');
          if (profilePicUrl === null) {
              alert("Profile picture upload failed, but member will be added without a picture.");
              // Continue, but URL will be null
          }
      }

       // Get next RMZ ID
      db.ref('users').orderByKey().limitToLast(1).once('value', async lastUserSnap => {
           let nextIdNumber = 1;
           if (lastUserSnap.exists()) {
                const lastUserKey = Object.keys(lastUserSnap.val())[0]; // Get the last key (which is the RMZ ID)
                // Extract number part, handle potential non-RMZ keys if any edge cases exist
                const match = lastUserKey.match(/RMZ(\d+)/);
                if (match && match[1]) {
                     const lastNum = parseInt(match[1], 10);
                     if (!isNaN(lastNum)) {
                         nextIdNumber = lastNum + 1;
                     }
                }
           }
           const newRmzID = `RMZ${nextIdNumber.toString().padStart(4, '0')}`; // e.g., RMZ0001

            const newUserData = {
                rmzID: newRmzID,
                name: name,
                mobile: mobile,
                email: email,
                shares: shares,
                profilePic: profilePicUrl, // Either uploaded URL or null
                createdAt: new Date().toISOString(),
                lastLogin: null, // New user, no previous login
                history: {} // Start with empty history object
            };

            // If initial shares > 0, add an initial history entry
            if (shares > 0) {
                const initialHistoryEntry = {
                    date: newUserData.createdAt,
                    shares: shares,
                    note: "Initial shares allocated"
                };
                // Add with a key (e.g., 'initial') into the history object
                 newUserData.history['initial'] = initialHistoryEntry;
                 // Alternatively, if you wanted Firebase to generate a unique key:
                 // delete newUserData.history; // Remove the empty object first
                 // const historyRef = db.ref('users/' + newRmzID + '/history');
                 // await historyRef.push(initialHistoryEntry);
            }

           try {
               // Save the new member using their RMZ ID as the key
                await db.ref('users/' + newRmzID).set(newUserData);
               alert(`Member ${newRmzID} added successfully!`);
               loadDashboard(); // Refresh dashboard
               closeAddModal(); // Close modal
           } catch (error) {
               console.error("Error adding new member:", error);
               alert("Error adding member: " + error.message);
                // No need for image rollback as we aren't managing the external storage deletion easily
           } finally {
               addButton.disabled = false;
               addButton.textContent = 'Add Member';
           }
      }).catch(error => {
           console.error("Error fetching last user ID:", error);
           alert("Could not determine the next RMZ ID. Member not added.");
           addButton.disabled = false;
           addButton.textContent = 'Add Member';
      });
  }

  // --- Notification Section ---

 function toggleNotificationSection() {
     const section = document.getElementById('notificationSection');
     section.style.display = section.style.display === 'none' ? 'block' : 'none';
     if (section.style.display === 'block') {
         loadNotifications(); // Load/refresh notifications when shown
     }
 }

 async function saveNotification() {
     const headline = document.getElementById('notificationHeadline').value.trim();
     const summary = document.getElementById('notificationSummary').value.trim();
     const link = document.getElementById('notificationLink').value.trim();
     const statusP = document.getElementById('notificationStatus');
     const saveBtn = document.getElementById('saveNotificationBtn');

     if (!headline || !summary) {
         alert("Please enter both Headline and Summary.");
         return;
     }

     saveBtn.disabled = true;
     saveBtn.textContent = 'Saving...';
     statusP.style.display = 'none'; // Hide previous status

     let imageUrl = originalNotificationImageUrl || document.getElementById('notificationImageLink').value || null; // Start with original or hidden link value

     // Check if new image file is selected
     if (document.getElementById('notificationImageFile').files.length > 0) {
         // Upload new image to ImgBB
         const uploadedUrl = await uploadImageToImgBB('notificationImageFile', 'notificationImageStatus');
         if (uploadedUrl) {
             // --- Removed Firebase Storage Deletion of Old Image ---
             // No action needed to delete the old image from ImgBB here.
             imageUrl = uploadedUrl; // Use the new URL
         } else {
             // Upload failed, notify user, but save text
             alert("Image upload failed. Notification will be saved without the new image.");
             // imageUrl retains the old value (or null)
         }
     }


     const notificationData = {
         headline: headline,
         summary: summary,
         link: link || null, // Save null if empty
         imageUrl: imageUrl, // Either new URL, original URL, or null
         timestamp: new Date().toISOString()
     };

     // Update/set at 'current_notification' path in Firebase
     db.ref('current_notification').set(notificationData)
         .then(() => {
             // On success, also add to history
             return db.ref('notification_history').push(notificationData);
         })
         .then(() => {
             statusP.textContent = "Notification updated successfully!";
             statusP.style.color = 'green';
             statusP.style.display = 'block';
             // Clear form fields and reset preview
             document.getElementById('notificationHeadline').value = '';
             document.getElementById('notificationSummary').value = '';
             document.getElementById('notificationLink').value = '';
             document.getElementById('notificationImageFile').value = null;
             document.getElementById('notificationImageLink').value = ''; // Clear hidden link
             setPreviewFromUrl(null, 'notificationImagePreview');
             document.getElementById('notificationImageStatus').textContent = '';
             originalNotificationImageUrl = ''; // Reset original URL holder
             loadNotifications(); // Refresh list
         })
         .catch((error) => {
             console.error("Error saving notification:", error);
             statusP.textContent = "Error saving notification: " + error.message;
             statusP.style.color = 'red';
             statusP.style.display = 'block';
             // No image rollback needed for ImgBB
         })
         .finally(() => {
             saveBtn.disabled = false;
             saveBtn.textContent = 'Update Notification';
         });
 }


 function loadNotifications() {
     const previousList = document.getElementById('previousNotifications');
     previousList.innerHTML = '<li>Loading...</li>'; // Loading indicator

     // 1. Load current active notification (if any) and populate form
     db.ref('current_notification').once('value', snapshot => {
         if (snapshot.exists()) {
             const currentNotif = snapshot.val();
             document.getElementById('notificationHeadline').value = currentNotif.headline || '';
             document.getElementById('notificationSummary').value = currentNotif.summary || '';
             document.getElementById('notificationLink').value = currentNotif.link || '';
             document.getElementById('notificationImageLink').value = currentNotif.imageUrl || ''; // Store URL in hidden input (useful if reusing without new upload)
             originalNotificationImageUrl = currentNotif.imageUrl || ''; // Store original URL
             setPreviewFromUrl(currentNotif.imageUrl, 'notificationImagePreview');
             document.getElementById('notificationImageFile').value = null; // Reset file input
             document.getElementById('notificationImageStatus').textContent = '';
         } else {
             // Clear form if no current notification
              document.getElementById('notificationHeadline').value = '';
              document.getElementById('notificationSummary').value = '';
              document.getElementById('notificationLink').value = '';
              document.getElementById('notificationImageFile').value = null;
              document.getElementById('notificationImageLink').value = '';
              setPreviewFromUrl(null, 'notificationImagePreview');
              document.getElementById('notificationImageStatus').textContent = '';
              originalNotificationImageUrl = '';
         }
     });

     // 2. Load history of previous notifications
     db.ref('notification_history')
       .orderByChild('timestamp') // Order by timestamp
       .limitToLast(MAX_NOTIFICATIONS_DISPLAY) // Get latest N
       .once('value', snapshot => {
         let html = '';
         if (snapshot.exists()) {
             const notifications = [];
             snapshot.forEach(childSnapshot => {
                 notifications.push({ key: childSnapshot.key, ...childSnapshot.val() });
             });
             // Reverse to show latest first
             notifications.reverse();

             notifications.forEach(notif => {
                 html += `<li>
                     <strong>${notif.headline}</strong> (${formatDateTime(notif.timestamp)})<br>
                     <small>${notif.summary.substring(0, 50)}...</small>
                     <button onclick="deleteNotificationHistory('${notif.key}')" style="margin-left: 10px; font-size: 0.7rem; padding: 2px 5px; cursor: pointer; background: #ffdddd; border: 1px solid #f7a7a7; border-radius: 3px;">Delete</button>
                     <button onclick="reuseNotification('${notif.key}')" style="margin-left: 5px; font-size: 0.7rem; padding: 2px 5px; cursor: pointer; background: #ddeeff; border: 1px solid #a7c7f7; border-radius: 3px;">Reuse</button>
                 </li>`;
             });
         } else {
             html = '<li>No previous notifications found.</li>';
         }
         previousList.innerHTML = html;
     }).catch(error => {
         console.error("Error loading notification history:", error);
         previousList.innerHTML = '<li>Error loading history.</li>';
     });
 }

 // Function to delete a specific historical notification
 function deleteNotificationHistory(key) {
    if (!key) return;
    if (confirm("Are you sure you want to delete this notification from history?")) {
        // Note: This only deletes the history record in Firebase.
        // The image (if any) will remain hosted on ImgBB.
        db.ref('notification_history/' + key).remove()
            .then(() => {
                console.log("Notification history entry deleted:", key);
                loadNotifications(); // Refresh list
            })
            .catch(error => {
                console.error("Error deleting notification history:", error);
                alert("Could not delete notification history entry.");
            });
    }
 }

// Function to reload a previous notification into the form for editing
function reuseNotification(key) {
    if (!key) return;
    db.ref('notification_history/' + key).once('value', snapshot => {
        if (snapshot.exists()) {
            const notif = snapshot.val();
             document.getElementById('notificationHeadline').value = notif.headline || '';
             document.getElementById('notificationSummary').value = notif.summary || '';
             document.getElementById('notificationLink').value = notif.link || '';
             document.getElementById('notificationImageLink').value = notif.imageUrl || ''; // Store URL in hidden input
             originalNotificationImageUrl = notif.imageUrl || ''; // Store as original for potential save
             setPreviewFromUrl(notif.imageUrl, 'notificationImagePreview');
             document.getElementById('notificationImageFile').value = null; // Reset file input
             document.getElementById('notificationImageStatus').textContent = '';
             alert("Notification content loaded into the form. You can now edit and click 'Update Notification' to make it the current one.");
        } else {
            alert("Could not find the selected notification history entry.");
        }
    }).catch(error => {
        console.error("Error reusing notification:", error);
        alert("Error loading notification data for reuse.");
    });
}


  // Initial load is triggered by checkPassword() upon successful login
 // loadDashboard(); // Called after password check is successful
</script>

</body>
</html>